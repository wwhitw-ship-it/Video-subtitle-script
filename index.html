<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥µé€Ÿè…³æœ¬å¤§å¸« Pro</title>
    
    <!-- 1. è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. è¼‰å…¥ React æ ¸å¿ƒ -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. è¼‰å…¥ Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- è‡ªè¨‚æ¨£å¼ -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .animate-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-text { transition: opacity 0.3s ease; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-white text-gray-900 min-h-screen selection:bg-indigo-100 selection:text-indigo-900">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --------------------------------------------------------------------------
        // ICONS
        // --------------------------------------------------------------------------
        const Icon = ({ path, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const icons = {
            Users: <g><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></g>,
            Settings: <g><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></g>,
            Key: <path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/>,
            Shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>,
            FileText: <g><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></g>,
            Upload: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></g>,
            RefreshCw: <g><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></g>,
            Zap: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>,
            AlertCircle: <g><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></g>,
            LayoutTemplate: <g><rect width="18" height="7" x="3" y="3" rx="1"/><rect width="9" height="7" x="3" y="14" rx="1"/><rect width="5" height="7" x="16" y="14" rx="1"/></g>,
            Clock: <g><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></g>,
            Info: <g><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></g>,
            Instagram: <g><rect width="20" height="20" x="2" y="2" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></g>,
            Files: <g><path d="M15.5 2H8.6c-.4 0-.8.2-1.1.5-.3.3-.5.7-.5 1.1v12.8c0 .4.2.8.5 1.1.3.3.7.5 1.1.5h9.8c.4 0 .8-.2 1.1-.5.3-.3.5-.7.5-1.1V6.5L15.5 2z"/><path d="M3 7.6v12.8c0 .4.2.8.5 1.1.3.3.7.5 1.1.5h9.8"/><path d="M15 2v5h5"/></g>,
            Table: <g><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="12" y1="3" x2="12" y2="21"/></g>,
            Sparkles: <g><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 5H5"/><path d="M19 15v4"/><path d="M23 17h-4"/></g>,
            Cpu: <rect x="4" y="4" width="16" height="16" rx="2" ry="2" />,
            CheckCircle: <g><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></g>
        };

        const LucideIcon = ({ name, size, className }) => (
            <Icon path={icons[name] || icons['Info']} size={size} className={className} />
        );

        // --------------------------------------------------------------------------
        // CONFIG
        // --------------------------------------------------------------------------
        const HARDCODED_API_KEY = ""; 
        const FALLBACK_MODELS = [
            "gemini-2.5-flash",          
            "gemini-2.0-flash-exp",
            "gemini-1.5-flash",          
            "gemini-1.5-flash-latest",   
            "gemini-1.5-flash-001",
            "gemini-1.5-flash-002",
            "gemini-1.5-flash-8b",
            "gemini-1.5-pro",
            "gemini-pro"
        ];

        // --------------------------------------------------------------------------
        // HELPER FUNCTIONS
        // --------------------------------------------------------------------------
        const estimateDuration = (text) => Math.ceil(text.replace(/\s/g, '').length / 4.5);

        const formatTimeRange = (sections, currentIndex) => {
            let startTime = 0;
            for (let i = 0; i < currentIndex; i++) startTime += sections[i].duration;
            const endTime = startTime + sections[currentIndex].duration;
            return `${startTime}-${endTime}ç§’`;
        };

        // â˜…â˜…â˜… Excel è¤‡è£½å°ˆç”¨ï¼šä¸‰æ¬„å¼ + è—ç™½é¢¨æ ¼ â˜…â˜…â˜…
        const copyHtmlToClipboard = (result, sourceSummary) => {
            if (!result) return;
            
            const overview = sourceSummary ? sourceSummary.overview : "";
            const tags = sourceSummary ? sourceSummary.tags.join(', ') : "";

            const headerBg = "#004e98"; 
            const headerText = "white"; 
            const labelBg = "#004e98";
            const labelText = "white";
            const contentBg = "#ffffff"; 
            const borderColor = "#999999";

            const tableHtml = `
                <table border="1" style="border-collapse: collapse; font-family: 'Microsoft JhengHei', sans-serif;">
                    <tr>
                        <td style="background-color: ${labelBg}; color: ${labelText}; font-weight: bold; width: 100px; text-align: center; vertical-align: middle;">æ‘˜è¦</td>
                        <td colspan="2" style="background-color: ${contentBg}; color: #000000; text-align: left; vertical-align: middle; padding: 5px;">${overview}</td>
                    </tr>
                    <tr>
                        <td style="background-color: ${labelBg}; color: ${labelText}; font-weight: bold; text-align: center; vertical-align: middle;">é—œéµå­—</td>
                        <td colspan="2" style="background-color: ${contentBg}; color: #000000; text-align: left; vertical-align: middle; padding: 5px;">${tags}</td>
                    </tr>
                    <tr>
                        <td style="background-color: ${labelBg}; color: ${labelText}; font-weight: bold; text-align: center; vertical-align: middle;">ç‰ˆæœ¬</td>
                        <td colspan="2" style="background-color: ${contentBg}; color: #000000; text-align: left; vertical-align: middle; padding: 5px;">${result.versionName}</td>
                    </tr>
                    <tr>
                        <td style="background-color: ${labelBg}; color: ${labelText}; font-weight: bold; text-align: center; vertical-align: middle;">ä¸»é¡Œåç¨±</td>
                        <td colspan="2" style="background-color: ${contentBg}; color: #000000; text-align: left; vertical-align: middle; padding: 5px;">${result.title}</td>
                    </tr>
                    <tr>
                        <td style="background-color: ${labelBg}; color: ${labelText}; font-weight: bold; text-align: center; vertical-align: middle;">é‡é»</td>
                        <td colspan="2" style="background-color: ${contentBg}; color: #000000; text-align: left; vertical-align: middle; padding: 5px;">${result.theme}</td>
                    </tr>
                    
                    <tr><td colspan="3" style="border: none; height: 10px;"></td></tr>

                    <tr style="background-color: ${headerBg}; color: ${headerText}; text-align: center; font-weight: bold;">
                        <td style="padding: 8px; width: 150px;">çµæ§‹</td>
                        <td style="padding: 8px; width: 100px;">æ™‚é–“</td>
                        <td style="padding: 8px; width: 600px;">è…³æœ¬/å°ç™½é‡é» (Audio)</td>
                    </tr>
                    
                    ${result.sections.map((s, idx) => `
                        <tr>
                            <td style="padding: 8px; vertical-align: top; text-align: center; border: 1px solid ${borderColor};">
                                <div style="font-weight: bold; color: ${headerBg}; font-size: 1.1em;">${s.structure}</div>
                                <div style="font-size: 0.9em; color: #555; margin-top: 4px;">(${s.structureDesc || ''})</div>
                            </td>
                            <td style="padding: 8px; vertical-align: top; text-align: center; border: 1px solid ${borderColor};">
                                ${formatTimeRange(result.sections, idx)}
                            </td>
                            <td style="padding: 8px; vertical-align: top; text-align: left; border: 1px solid ${borderColor};">
                                ${s.content.replace(/\n/g, '<br>')}
                            </td>
                        </tr>
                    `).join('')}
                </table>
            `;

            const hiddenDiv = document.createElement('div');
            hiddenDiv.innerHTML = tableHtml;
            hiddenDiv.style.position = 'fixed';
            hiddenDiv.style.left = '-9999px';
            hiddenDiv.style.top = '0';
            document.body.appendChild(hiddenDiv);

            const range = document.createRange();
            range.selectNode(hiddenDiv);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            try {
                const success = document.execCommand('copy');
            } catch (err) {
                console.error('è¤‡è£½å¤±æ•—', err);
            }
            
            document.body.removeChild(hiddenDiv);
            selection.removeAllRanges();
        };

        const copyToClipboard = (text) => { const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); };
        const handleCopyTitle = (t, setFn) => { copyToClipboard(t); setFn(t); setTimeout(() => setFn(null), 2000); };
        
        // è¤‡è£½æ‰€æœ‰ (ç´”æ–‡å­—)
        const handleCopyAll = (results, sourceSummary, setFn) => {
            if (!results) return;
            let summaryText = "";
            if (sourceSummary) {
                summaryText = `ã€ä¾†æºå°è¦½ã€‘\næ‘˜è¦ï¼š${sourceSummary.overview}\né—œéµå­—ï¼š${sourceSummary.tags.join(', ')}\n\n========================================\n\n`;
            }
            const generateText = (res) => {
                const header = `ç‰ˆæœ¬ï¼š${res.versionName}\nä¸»é¡Œï¼š${res.title}\né‡é»ï¼š${res.theme}\n\nçµæ§‹\tæ™‚é–“\tå°ç™½`;
                const body = res.sections.map((s, i) => `${s.structure}(${s.structureDesc||''})\t${formatTimeRange(res.sections, i)}\t${s.content.replace(/\n/g, ' ')}`).join('\n');
                return `${header}\n${body}`;
            };
            const allText = [summaryText, generateText(results.A), '-------------------', generateText(results.B), '-------------------', generateText(results.Mix)].join('\n\n');
            copyToClipboard(allText);
            setFn("âœ… å·²è¤‡è£½å…¨éƒ¨å…§å®¹ (ç´”æ–‡å­—)");
            setTimeout(() => setFn(null), 2000);
        };

        // --------------------------------------------------------------------------
        // APP
        // --------------------------------------------------------------------------
        function App() {
            const [fileContent, setFileContent] = useState('');
            const [fileName, setFileName] = useState('');
            const [isDragging, setIsDragging] = useState(false);
            const [isProcessing, setIsProcessing] = useState(false);
            const [processingStatus, setProcessingStatus] = useState('');
            const [logs, setLogs] = useState([]);
            const [activeVersion, setActiveVersion] = useState('A');
            
            const getEnvApiKey = () => {
                try {
                    if (typeof process !== 'undefined' && process.env && process.env.REACT_APP_GEMINI_API_KEY) {
                        return process.env.REACT_APP_GEMINI_API_KEY;
                    }
                } catch (e) {}
                return '';
            };

            const [apiKey, setApiKey] = useState(HARDCODED_API_KEY || getEnvApiKey());
            const [selectedModel, setSelectedModel] = useState("gemini-2.5-flash");
            const [customModel, setCustomModel] = useState("");
            const [showSettings, setShowSettings] = useState(false);
            const [testStatus, setTestStatus] = useState(null); 
            const [testMsg, setTestMsg] = useState("");
            
            const [results, setResults] = useState(null);
            const [sourceSummary, setSourceSummary] = useState(null);
            const [error, setError] = useState(null);
            const [copiedTitle, setCopiedTitle] = useState(null);
            const [isMock, setIsMock] = useState(false);

            // Mock Data
            const generateMockResult = () => {
                setSourceSummary({
                    overview: "é€™æ®µå°è©±å‘ˆç¾äº†å…¸å‹çš„ã€Œæˆ€æ„›è…¦ã€èˆ‡ã€Œäººé–“æ¸…é†’ã€ä¹‹é–“çš„è§€å¿µè¡çªã€‚ä¸»è§’ A å°æ–¼ç”·æ€§çš„æ™®é€šç¤¾äº¤è¡Œç‚ºç”¢ç”Ÿäº†éåº¦çš„æµªæ¼«è§£è®€ï¼Œè€Œæœ‹å‹ B å‰‡è©¦åœ–ç”¨ç†æ€§çš„è§’åº¦æˆ³ç ´å¹»æƒ³ã€‚",
                    tags: ["æˆ€æ„›è…¦", "å·¥å…·äºº", "ç¤¾äº¤éŒ¯è¦º", "äººé–“æ¸…é†’", "å…©æ€§äº’å‹•"]
                });
                const sectionsA = [
                    { structure: "èµ·", structureDesc: "èˆˆå¥®æšˆèˆ¹", content: `Aï¼šã€Œå¤©å•Šï¼é‚£å€‹è¶…å¸¥çš„ç”·ç”Ÿæ˜¨å¤©ç«Ÿç„¶è·Ÿæˆ‘èªªæ™šå®‰è€¶ï¼ä»–æ˜¯ä¸æ˜¯å–œæ­¡æˆ‘ï¼Ÿã€\nBï¼šã€Œä»–æ˜¯æœ‰æ¯›ç—…å§ï¼Ÿæ™šå®‰å°±æ˜¯æƒ³ç¡è¦ºäº†ã€‚ã€`, visual: "å¥³ç”ŸAä¸€è‡‰èŠ±ç™¡ã€‚Bå†·æ¼ ç¿»ç™½çœ¼ã€‚", duration: 10 },
                    { structure: "æ‰¿", structureDesc: "å·¥å…·äººè¡Œç‚º", content: `Bï¼šã€Œé‚£ä»–æœ‰è²·æ—©é¤çµ¦ä½ å—ï¼Ÿã€\nAï¼šã€Œæ²’æœ‰å•Šï¼ä½†æˆ‘æœ‰è«‹ä»–å–é£²æ–™ã€é‚„æœ‰å¹«ä»–å«è»Šï¼ã€`, visual: "Bè³ªå•Aï¼ŒAç†æ‰€ç•¶ç„¶å›ç­”ã€‚", duration: 15 },
                    { structure: "è½‰", structureDesc: "ç›²ç›®è‡ªä¿¡", content: `Aï¼šã€Œå¯æ˜¯ä»–èªªæˆ‘æ˜¯æœ€ã€ç‰¹åˆ¥ã€çš„é‚£å€‹è€¶ï¼ã€\nBï¼šã€Œå°ï¼Œã€ç‰¹åˆ¥ã€å¥½é¨™çš„é‚£å€‹ã€‚ã€`, visual: "Aéœ²å‡ºå¤¢å¹»è¡¨æƒ…ï¼ŒBç„¡æƒ…æˆ³ç ´ã€‚", duration: 15 },
                    { structure: "åˆ", structureDesc: "ç„¡è—¥å¯æ•‘", content: `Bï¼šï¼ˆå°é¡é ­ï¼‰ã€Œæœ‰é€™ç¨®æœ‹å‹ï¼Œæˆ‘è©²å ±è­¦é‚„æ˜¯å¹«å¥¹æ›è™Ÿè…¦ç§‘ï¼Ÿã€`, visual: "Bå°è‘—é¡é ­æ”¤æ‰‹æ–é ­ã€‚", duration: 10 },
                ];
                const processMock = (type, name, title) => ({
                    title, theme: "æ¢è¨æˆ€æ„›è…¦èˆ‡äººé–“æ¸…é†’çš„æ¥µè‡´åå·®", suggestedTitles: ["æšˆèˆ¹ä»”å¿…çœ‹ï¼ğŸ¤¡", "äººé–“æ¸…é†’ vs æˆ€æ„›è…¦ğŸ’”"],
                    versionType: type, versionName: name, totalDuration: 50, sections: sectionsA
                });
                setResults({
                    A: processMock('A', 'ç‰ˆæœ¬ä¸€ï¼šæƒ…å¢ƒåŠ‡ç‰ˆ', 'ã€å°è©±æƒ…å¢ƒã€‘æˆ€æ„›è…¦ vs æ¸…é†’äºº'),
                    B: processMock('B', 'ç‰ˆæœ¬äºŒï¼šçˆ†æ¬¾å¸ç›ç‰ˆ', 'ğŸ”¥ æˆ€æ„›è…¦ vs æ¸…é†’äºº'),
                    Mix: processMock('Mix', 'ç‰ˆæœ¬ä¸‰ï¼šå¹³è¡¡ç¶œåˆç‰ˆ', 'âœ¨ æˆ€æ„›è…¦ vs æ¸…é†’äºº')
                });
                setIsMock(true);
            };

            const testConnection = async () => {
                if (!apiKey.trim()) { setTestStatus('error'); setTestMsg('è«‹å…ˆè¼¸å…¥ API Key'); return; }
                const modelToTest = selectedModel === 'custom' ? customModel : selectedModel;
                setTestStatus('testing'); setTestMsg(`æ­£åœ¨æ¸¬è©¦é€£ç·šè‡³: ${modelToTest}...`);
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelToTest}:generateContent?key=${apiKey.trim()}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: "Hello" }] }] })
                    });
                    const data = await response.json();
                    if (response.ok && data.candidates) { setTestStatus('success'); setTestMsg(`âœ… æˆåŠŸï¼æ¨¡å‹ ${modelToTest} å¯ç”¨ã€‚`); }
                    else { setTestStatus('error'); setTestMsg(`âŒ å¤±æ•—: ${data.error?.message || response.statusText}`); }
                } catch (e) { setTestStatus('error'); setTestMsg(`ç¶²çµ¡éŒ¯èª¤: ${e.message}`); }
            };

            const callGeminiApi = async (modelName, text) => {
                const prompt = `
                    ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„çŸ­å½±éŸ³è…³æœ¬å¸«èˆ‡å…§å®¹åˆ†æå¸«ã€‚è«‹åˆ†æä»¥ä¸‹æ–‡å­—ç¨¿ï¼Œå®Œæˆå…©å€‹ä»»å‹™ï¼š
                    ä»»å‹™ä¸€ï¼šã€ä¾†æºå°è¦½ (Source Guide)ã€‘æ¨¡ä»¿ NotebookLM é¢¨æ ¼ï¼Œç”Ÿæˆ 100-150 å­—æ‘˜è¦ (overview) èˆ‡ 5-8 å€‹é—œéµå­— (tags)ã€‚
                    ä»»å‹™äºŒï¼šã€è…³æœ¬ç”Ÿæˆã€‘å°‡å…§å®¹æ”¹å¯«ç‚ºã€é›™äººå°è©± / æƒ…å¢ƒåŠ‡ (Skit)ã€‘é¢¨æ ¼è…³æœ¬ï¼Œç”Ÿæˆä¸‰å€‹ç‰ˆæœ¬ (A/B/Mix)ï¼Œç¸½æ™‚é•·ç´„ 40-50 ç§’ã€‚
                    è¼¸å…¥æ–‡å­—: """${text.substring(0, 15000)}"""
                    è«‹å›å‚³åš´æ ¼ JSON: { "source_summary": { "overview": "...", "tags": [...] }, "scripts": { "A": { "title": "...", "theme": "...", "suggested_titles": [...], "sections": [ { "structure": "èµ·", "structureDesc": "...", "content": "..." } ] }, "B": { ... }, "Mix": { ... } } }
                `;
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey.trim()}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                if (!data.candidates?.[0]?.content?.parts?.[0]?.text) throw new Error("API å›å‚³ç©ºè³‡æ–™");
                return data;
            };

            const generateAIResult = async (text) => {
                const userModel = selectedModel === 'custom' ? customModel : selectedModel;
                const modelsToTry = [userModel, ...FALLBACK_MODELS.filter(m => m !== userModel)];
                let lastError = null;
                setLogs([]);
                for (const model of modelsToTry) {
                    if(!model) continue;
                    try {
                        setProcessingStatus(`å˜—è©¦é€£ç·šï¼š${model}...`);
                        setLogs(p => [...p, { msg: `å˜—è©¦: ${model}...`, type: 'info' }]);
                        const data = await callGeminiApi(model, text);
                        setLogs(p => [...p, { msg: `âœ… æˆåŠŸ (${model})`, type: 'success' }]);
                        const rawText = data.candidates[0].content.parts[0].text;
                        const jsonText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                        const parsed = JSON.parse(jsonText);
                        setSourceSummary(parsed.source_summary);
                        const processVersion = (v, type, name) => ({
                            title: v.title, theme: v.theme, suggestedTitles: v.suggested_titles || [],
                            versionType: type, versionName: name,
                            sections: v.sections.map((s) => ({ ...s, duration: estimateDuration(s.content) })),
                            totalDuration: v.sections.reduce((acc, cur) => acc + estimateDuration(cur.content), 0)
                        });
                        setResults({
                            A: processVersion(parsed.scripts.A, 'A', 'ç‰ˆæœ¬ä¸€ï¼šå°è©±æƒ…å¢ƒç‰ˆ'),
                            B: processVersion(parsed.scripts.B, 'B', 'ç‰ˆæœ¬äºŒï¼šçˆ†æ¬¾åæ§½ç‰ˆ'),
                            Mix: processVersion(parsed.scripts.Mix, 'Mix', 'ç‰ˆæœ¬ä¸‰ï¼šå¹³è¡¡ç¶œåˆç‰ˆ')
                        });
                        setIsMock(false);
                        if(model !== userModel && selectedModel !== 'custom') setSelectedModel(model);
                        return;
                    } catch (e) {
                        setLogs(p => [...p, { msg: `âŒ ${model} å¤±æ•—: ${e.message.substring(0,30)}...`, type: 'error' }]);
                        lastError = e;
                    }
                }
                throw new Error("æ‰€æœ‰æ¨¡å‹çš†å¤±æ•—");
            };

            const handleAnalyze = async () => {
                if (!fileContent.trim()) { setError("è«‹å…ˆè¼¸å…¥å…§å®¹æˆ–ä¸Šå‚³æª”æ¡ˆ"); return; }
                setIsProcessing(true); setProcessingStatus('åˆå§‹åŒ–...'); setError(null); setResults(null); setSourceSummary(null);
                try {
                    if (apiKey && apiKey.trim().length > 10) await generateAIResult(fileContent);
                    else { await new Promise(r => setTimeout(r, 1500)); generateMockResult(); }
                } catch (err) { setError(err.message); } 
                finally { setIsProcessing(false); setProcessingStatus(''); }
            };

            const handleFileSelect = (e) => { if (e.target.files[0]) { const r = new FileReader(); r.onload = (ev) => { setFileContent(ev.target.result); setFileName(e.target.files[0].name); setError(null); }; r.readAsText(e.target.files[0]); } };
            const handleDrop = (e) => { e.preventDefault(); setIsDragging(false); const f = e.dataTransfer.files[0]; if (f && f.type === 'text/plain') { const r = new FileReader(); r.onload = (ev) => { setFileContent(ev.target.result); setFileName(f.name); setError(null); }; r.readAsText(f); } else setError('è«‹ä¸Šå‚³ .txt'); };

            const currentResult = results ? results[activeVersion] : null;

            return (
                <div className="pb-20">
                    <header className="border-b border-gray-200 bg-white sticky top-0 z-10">
                        <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <div className="bg-indigo-100 p-2 rounded-lg"><LucideIcon name="Users" size={20} className="text-indigo-600" /></div>
                                <h1 className="text-xl font-bold text-gray-900">æ¥µé€Ÿè…³æœ¬å¤§å¸« <span className="text-xs font-normal text-gray-500 px-2 border border-gray-200 rounded-full">Pro</span></h1>
                            </div>
                            <div className="flex items-center gap-3">
                                <div className="hidden md:flex items-center gap-1.5 px-3 py-1 rounded-full bg-gray-50 border border-gray-200 text-xs">
                                    {apiKey ? <><div className="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"></div><span className="text-gray-600">Gemini AI</span></> : <><div className="w-2 h-2 rounded-full bg-yellow-500"></div><span className="text-gray-600">æ¼”ç¤ºæ¨¡å¼</span></>}
                                </div>
                                <button onClick={() => setShowSettings(!showSettings)} className={`p-2 rounded-full transition-colors ${showSettings ? 'bg-indigo-50 text-indigo-600' : 'hover:bg-gray-100 text-gray-500'}`}><LucideIcon name="Settings" size={20} /></button>
                            </div>
                        </div>
                        {showSettings && (
                            <div className="bg-gray-50 border-b border-gray-200 p-4 animate-in">
                                <div className="max-w-6xl mx-auto flex flex-col md:flex-row gap-6">
                                    <div className="flex-1 w-full space-y-4">
                                        <div className="space-y-1">
                                            <div className="flex items-center gap-2 text-indigo-600 mb-1"><LucideIcon name="Key" size={16} /><label className="text-sm font-bold">Google Gemini API Key</label></div>
                                            <div className="flex gap-2">
                                                <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="è¼¸å…¥æ‚¨çš„ AIzaSy..." className="flex-1 bg-white border border-gray-300 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-indigo-500 transition-all text-gray-900" />
                                                <button onClick={testConnection} disabled={!apiKey || testStatus === 'testing'} className={`px-4 py-2 rounded-lg text-sm font-bold border ${testStatus === 'testing' ? 'bg-gray-100 border-gray-300 text-gray-400' : testStatus === 'success' ? 'bg-green-50 border-green-500 text-green-600' : testStatus === 'error' ? 'bg-red-50 border-red-500 text-red-600' : 'bg-indigo-600 border-indigo-600 text-white hover:bg-indigo-700'}`}>{testStatus === 'testing' ? 'é€£ç·šä¸­...' : 'æ¸¬è©¦é€£ç·š'}</button>
                                            </div>
                                            {testMsg && <div className={`text-xs mt-2 p-2 rounded ${testStatus === 'success' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>{testStatus === 'success' && <LucideIcon name="CheckCircle" size={12} className="inline mr-1" />}{testMsg}</div>}
                                        </div>
                                        <div className="space-y-1">
                                            <div className="flex items-center gap-2 text-pink-600 mb-1"><LucideIcon name="Cpu" size={16} /><label className="text-sm font-bold">é¸æ“‡ AI æ¨¡å‹</label></div>
                                            <div className="flex gap-2">
                                                <select value={selectedModel} onChange={(e) => setSelectedModel(e.target.value)} className="flex-1 bg-white border border-gray-300 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-pink-500 transition-all text-gray-900">
                                                    <option value="gemini-2.5-flash">Gemini 2.5 Flash (æ¨è–¦)</option>
                                                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp</option>
                                                    <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                                                    <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash Latest</option>
                                                    <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                                    <option value="custom">è‡ªè¨‚è¼¸å…¥ (Custom)</option>
                                                </select>
                                                {selectedModel === 'custom' && (
                                                    <input type="text" value={customModel} onChange={(e) => setCustomModel(e.target.value)} placeholder="å¦‚: gemini-1.5-flash-002" className="flex-1 bg-white border border-gray-300 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-pink-500 text-gray-900" />
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="md:w-1/3 bg-white p-4 rounded-lg border border-gray-200 text-xs text-gray-500 space-y-2">
                                        <h4 className="font-bold text-gray-700 flex items-center gap-2"><LucideIcon name="Shield" size={14} className="text-emerald-500" />é™¤éŒ¯æŒ‡å—</h4>
                                        <ul className="list-disc pl-4 space-y-1"><li>ä½¿ç”¨ã€Œæ¸¬è©¦é€£ç·šã€ç¢ºèª Key èˆ‡æ¨¡å‹æ˜¯å¦åŒ¹é…ã€‚</li><li>è‹¥ 404ï¼Œè«‹å˜—è©¦åˆ‡æ›ä¸‹æ‹‰é¸å–®ä¸­çš„æ¨¡å‹ã€‚</li><li>è‹¥ 403ï¼Œè«‹æª¢æŸ¥ Google Cloud å°ˆæ¡ˆæ¬Šé™ã€‚</li></ul>
                                    </div>
                                </div>
                            </div>
                        )}
                    </header>

                    <main className="max-w-6xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div className="space-y-6">
                            <div className="flex items-center justify-between">
                                <h2 className="text-lg font-semibold flex items-center gap-2 text-gray-800"><LucideIcon name="FileText" size={20} className="text-indigo-600" />åŸå§‹ç´ æ</h2>
                                {fileContent && <button onClick={() => {setFileContent(''); setFileName(''); setResults(null); setSourceSummary(null); setLogs([]); setError(null);}} className="text-xs text-red-500 hover:text-red-700">æ¸…é™¤å…§å®¹</button>}
                            </div>
                            <div className={`relative group border-2 border-dashed rounded-xl transition-all duration-300 h-[500px] flex flex-col ${isDragging ? 'border-indigo-500 bg-indigo-50' : 'border-gray-300 bg-gray-50 hover:bg-white'}`} onDragOver={(e) => {e.preventDefault(); setIsDragging(true);}} onDragLeave={() => setIsDragging(false)} onDrop={handleDrop}>
                                {!fileContent ? (
                                    <div className="flex-1 flex flex-col items-center justify-center p-8 text-center">
                                        <div className="w-16 h-16 bg-white rounded-full shadow-sm flex items-center justify-center mb-4 group-hover:scale-110 transition-transform"><LucideIcon name="Upload" size={32} className="text-gray-400" /></div>
                                        <h3 className="text-lg font-medium text-gray-700 mb-2">æ‹–æ”¾ .txt æª”æ¡ˆè‡³æ­¤</h3>
                                        <p className="text-sm text-gray-500 mb-6">æˆ–ç›´æ¥è²¼ä¸Šæ–‡å­—å…§å®¹</p>
                                        <label className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg cursor-pointer transition-colors shadow-lg shadow-indigo-200">é¸æ“‡æª”æ¡ˆ<input type="file" className="hidden" accept=".txt" onChange={handleFileSelect} /></label>
                                    </div>
                                ) : (
                                    <div className="flex-1 flex flex-col p-4">
                                        <div className="flex items-center justify-between mb-2 text-xs text-gray-500"><span className="truncate max-w-[200px]">{fileName || 'æ‰‹å‹•è¼¸å…¥'}</span><span>{fileContent.length} å­—</span></div>
                                        <textarea className="flex-1 w-full bg-transparent resize-none focus:outline-none text-gray-800 text-sm leading-relaxed" value={fileContent} onChange={(e) => setFileContent(e.target.value)} placeholder="åœ¨æ­¤ç·¨è¼¯æˆ–è²¼ä¸Šæ–‡å­—..." />
                                    </div>
                                )}
                                <div className="p-4 border-t border-gray-200 bg-gray-50 rounded-b-xl space-y-2">
                                    <button onClick={handleAnalyze} disabled={isProcessing || !fileContent} className={`w-full py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-all ${isProcessing || !fileContent ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white shadow-lg shadow-indigo-200'}`}>
                                        {isProcessing ? <><LucideIcon name="RefreshCw" size={20} className="animate-spin mr-2" /><span className="fade-text">{processingStatus || "æ­£åœ¨åˆ†æèˆ‡ç”Ÿæˆ..."}</span></> : <><LucideIcon name="Zap" size={20} className="mr-2" />{apiKey ? "é–‹å§‹ç”Ÿæˆ (Gemini AI)" : "é–‹å§‹ç”Ÿæˆ (æ¼”ç¤ºæ¨¡å¼)"}</>}
                                    </button>
                                    {logs.length > 0 && <div className="text-[10px] text-gray-600 max-h-24 overflow-y-auto font-mono bg-white p-2 rounded border border-gray-200 space-y-1 scrollbar-hide">{logs.map((log, i) => <div key={i} className={log.type === 'error' ? 'text-red-500' : log.type === 'success' ? 'text-green-600 font-bold' : ''}>{log.msg}</div>)}</div>}
                                </div>
                            </div>
                            {error && <div className="flex flex-col gap-2 p-3 rounded-lg text-sm border border-red-200 bg-red-50 animate-in"><div className="flex items-center gap-2 text-red-500"><LucideIcon name="AlertCircle" size={16} /><span className="font-bold">ç”Ÿæˆå¤±æ•—</span></div><p className="text-red-600 text-xs">{error}</p></div>}
                        </div>

                        <div className="space-y-6">
                            <h2 className="text-lg font-semibold flex items-center gap-2 text-gray-800"><LucideIcon name="LayoutTemplate" size={20} className="text-purple-500" />åˆ†æçµæœ</h2>
                            {!currentResult ? (
                                <div className="h-[500px] border border-gray-200 rounded-xl bg-gray-50 flex flex-col items-center justify-center text-gray-400"><div className="p-4 rounded-full bg-white shadow-sm mb-4"><LucideIcon name="Clock" size={32} className="opacity-50" /></div><p>ç­‰å¾…åˆ†æ...</p><p className="text-sm mt-2 opacity-50">è«‹ä¸Šå‚³æ–‡å­—ä¸¦é»æ“Šç”Ÿæˆ</p></div>
                            ) : (
                                <div className="flex flex-col h-full space-y-6 animate-in">
                                    {sourceSummary && (
                                        <div className="bg-white rounded-xl border border-gray-200 p-5 shadow-lg relative overflow-hidden group">
                                            <div className="absolute top-0 right-0 w-64 h-64 bg-indigo-50 rounded-full blur-3xl -mr-32 -mt-32 pointer-events-none"></div>
                                            <div className="flex items-center gap-2 mb-3 text-indigo-600"><LucideIcon name="Sparkles" size={18} /><h3 className="font-bold text-sm tracking-wide uppercase">ä¾†æºå°è¦½ (Source Guide)</h3></div>
                                            <div className="relative z-10"><p className="text-gray-700 text-sm leading-relaxed mb-4">{sourceSummary.overview}</p><div className="flex flex-wrap gap-2">{sourceSummary.tags.map((tag, i) => <span key={i} className="px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-600 text-xs rounded-full border border-gray-200 transition-colors cursor-default">#{tag}</span>)}</div></div>
                                        </div>
                                    )}
                                    <div className="space-y-4">
                                        <div className="flex p-1 bg-gray-100 rounded-lg">
                                            <button onClick={() => setActiveVersion('A')} className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${activeVersion === 'A' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-900'}`}>ç‰ˆæœ¬ä¸€ (A)</button>
                                            <button onClick={() => setActiveVersion('B')} className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${activeVersion === 'B' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-900'}`}>ç‰ˆæœ¬äºŒ (B)</button>
                                            <button onClick={() => setActiveVersion('Mix')} className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${activeVersion === 'Mix' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-900'}`}>ç‰ˆæœ¬ä¸‰ (Mix)</button>
                                        </div>
                                        {isMock && <div className="bg-yellow-50 border border-yellow-200 text-yellow-700 text-xs p-3 rounded-lg flex items-center gap-2"><LucideIcon name="Info" size={16} className="text-yellow-600" /><span>æ¼”ç¤ºæ¨¡å¼ï¼šæ­¤ç‚ºæ¨¡æ“¬è³‡æ–™ã€‚è«‹è¼¸å…¥ API Key ä»¥ç²å¾—çœŸå¯¦åˆ†æã€‚</span></div>}
                                        <div className="bg-white rounded-lg shadow-xl overflow-hidden flex flex-col text-gray-900 font-sans border border-gray-200">
                                            <div className="bg-[#004e98] text-white p-3 flex justify-between items-center"><div className="font-bold text-lg tracking-wide truncate pr-4">{currentResult.versionName}: ã€{currentResult.title}ã€‘</div><div className="text-xs bg-white/20 px-2 py-1 rounded whitespace-nowrap">ç¸½æ™‚é•·: {currentResult.totalDuration}s</div></div>
                                            <div className="bg-white p-4 text-center border-b border-gray-200"><p className="text-gray-800 font-medium"><span className="font-bold text-[#004e98] mr-2">é‡é»:</span>{currentResult.theme}</p></div>
                                            {currentResult.suggestedTitles && currentResult.suggestedTitles.length > 0 && <div className="bg-gradient-to-r from-pink-50 to-purple-50 p-4 border-t border-b border-gray-200"><h4 className="text-xs font-bold text-gray-600 uppercase mb-3 flex items-center gap-1.5"><LucideIcon name="Instagram" size={14} className="text-pink-600" />IG Reels å¸ç›æ¨™é¡Œå»ºè­° (é»æ“Šè¤‡è£½)</h4><div className="flex flex-wrap gap-2">{currentResult.suggestedTitles.map((t, i) => <button key={i} onClick={() => handleCopyTitle(t, setCopiedTitle)} className={`px-3 py-1.5 rounded-full text-sm font-medium border shadow-sm transition-all ${copiedTitle === t ? 'bg-green-100 border-green-300 text-green-700 scale-105' : 'bg-white border-gray-200 text-gray-600 hover:border-pink-300 hover:text-pink-600 hover:bg-pink-50'}`}>{copiedTitle === t ? 'å·²è¤‡è£½! âœ…' : t}</button>)}</div></div>}
                                            <div className="grid grid-cols-12 border-b border-gray-200 bg-gray-50 text-sm font-bold text-gray-700"><div className="col-span-3 p-3 border-r border-gray-200 text-center flex items-center justify-center">çµæ§‹</div><div className="col-span-2 p-3 border-r border-gray-200 text-center flex items-center justify-center">æ™‚é–“ä½”æ¯”</div><div className="col-span-7 p-3 text-center flex items-center justify-center">è…³æœ¬/å°ç™½é‡é» (Audio)</div></div>
                                            <div className="overflow-auto max-h-[500px]">{currentResult.sections.map((section, idx) => <div key={idx} className="grid grid-cols-12 border-b border-gray-100 text-sm hover:bg-gray-50 transition-colors"><div className="col-span-3 p-3 border-r border-gray-200 font-bold text-gray-700 flex flex-col justify-center items-center text-center bg-gray-50/50"><span className="text-lg text-[#004e98]">{section.structure}</span>{section.structureDesc && <span className="text-xs text-gray-500 mt-1 font-normal break-words px-1">({section.structureDesc})</span>}</div><div className="col-span-2 p-3 border-r border-gray-200 flex items-center justify-center text-gray-600 font-mono text-center">{formatTimeRange(currentResult.sections, idx)}</div><div className="col-span-7 p-3 text-gray-800 leading-relaxed font-medium whitespace-pre-wrap">{section.content}</div></div>)}</div>
                                            <div className="p-3 bg-gray-50 border-t border-gray-200 flex justify-end gap-2"><button onClick={() => handleCopyAll(results, sourceSummary, setCopiedTitle)} className="flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded shadow-sm text-sm transition-colors"><LucideIcon name="Files" size={16} />è¤‡è£½æ‰€æœ‰ (å«ä¾†æº)</button><button onClick={() => copyHtmlToClipboard(currentResult, sourceSummary)} className="flex items-center gap-2 px-4 py-2 bg-[#004e98] hover:bg-[#003d7a] text-white rounded shadow-sm text-sm transition-colors"><LucideIcon name="Table" size={16} />è¤‡è£½ Excel æ ¼å¼</button></div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                    {copiedTitle && <div className="fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-in">{copiedTitle}</div>}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
