<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê•µÈÄüËÖ≥Êú¨Â§ßÂ∏´ Pro (NotebookLM Style)</title>
    
    <!-- 1. ËºâÂÖ• Tailwind CSS (Ê®£Âºè) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. ËºâÂÖ• React Ê†∏ÂøÉ -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. ËºâÂÖ• Babel (Âª∫Ë≠∞‰ΩøÁî®ËºÉÊñ∞ÁâàÊú¨‰ª•ÊîØÊè¥Êñ∞Ë™ûÊ≥ïÔºåÊ≠§Ëôï‰ΩøÁî® @babel/standalone) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Ëá™Ë®ÇÊ®£Âºè -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .animate-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen selection:bg-indigo-500 selection:text-white">

    <!-- React ÊáâÁî®Á®ãÂºèÊéõËºâÈªû -->
    <div id="root"></div>

    <!-- 4. ÊáâÁî®Á®ãÂºèÈÇèËºØ -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --------------------------------------------------------------------------
        // ICON COMPONENTS (Âèñ‰ª£ lucide-reactÔºåÁõ¥Êé•ÂÖßÂµå SVG ‰ª•Á¢∫‰øùÂñÆÊ™îÈÅã‰Ωú)
        // --------------------------------------------------------------------------
        const Icon = ({ path, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        // ‰øÆÊ≠£: Â∞á <>...</> ÊõøÊèõÁÇ∫ <g>...</g> ‰ª•Áõ∏ÂÆπ JSX Ëß£Êûê
        const icons = {
            Users: <g><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></g>,
            Settings: <g><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></g>,
            Key: <path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/>,
            Shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>,
            FileText: <g><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></g>,
            Upload: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></g>,
            RefreshCw: <g><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></g>,
            Zap: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>,
            AlertCircle: <g><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></g>,
            LayoutTemplate: <g><rect width="18" height="7" x="3" y="3" rx="1"/><rect width="9" height="7" x="3" y="14" rx="1"/><rect width="5" height="7" x="16" y="14" rx="1"/></g>,
            Clock: <g><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></g>,
            Info: <g><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></g>,
            Instagram: <g><rect width="20" height="20" x="2" y="2" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></g>,
            Files: <g><path d="M15.5 2H8.6c-.4 0-.8.2-1.1.5-.3.3-.5.7-.5 1.1v12.8c0 .4.2.8.5 1.1.3.3.7.5 1.1.5h9.8c.4 0 .8-.2 1.1-.5.3-.3.5-.7.5-1.1V6.5L15.5 2z"/><path d="M3 7.6v12.8c0 .4.2.8.5 1.1.3.3.7.5 1.1.5h9.8"/><path d="M15 2v5h5"/></g>,
            Table: <g><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="12" y1="3" x2="12" y2="21"/></g>,
            Sparkles: <g><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 5H5"/><path d="M19 15v4"/><path d="M23 17h-4"/></g>
        };

        const LucideIcon = ({ name, size, className }) => (
            <Icon path={icons[name]} size={size} className={className} />
        );

        // --------------------------------------------------------------------------
        // CONFIGURATION
        // --------------------------------------------------------------------------
        const GEMINI_MODEL = "gemini-1.5-flash";
        // Â¶ÇÊûú‰Ω†ÊÉ≥Êää API Key ÂØ´Ê≠ªÂú®Ê™îÊ°àË£°Êñπ‰æøÂàÜ‰∫´ (‰∏çÂª∫Ë≠∞ÂÖ¨ÈñãÂà∞ GitHub)ÔºåÂèØ‰ª•Â°´Âú®‰∏ãÊñπÂºïËôü‰∏≠
        const HARDCODED_API_KEY = ""; 

        // --------------------------------------------------------------------------
        // HELPER FUNCTIONS
        // --------------------------------------------------------------------------
        const estimateDuration = (text) => {
            const charCount = text.replace(/\s/g, '').length;
            return Math.ceil(charCount / 4.5);
        };

        const formatTimeRange = (sections, currentIndex) => {
            let startTime = 0;
            for (let i = 0; i < currentIndex; i++) {
                startTime += sections[i].duration;
            }
            const endTime = startTime + sections[currentIndex].duration;
            return `${startTime}-${endTime}Áßí`;
        };

        const generateCopyString = (result) => {
            const headers = "ÁµêÊßã\tÊôÇÈñì‰ΩîÊØî\tËÖ≥Êú¨/Â∞çÁôΩÈáçÈªû (Audio)";
            const versionInfo = `ÁâàÊú¨Ôºö${result.versionName}\n‰∏ªÈ°åÂêçÁ®±Ôºö${result.title}\nÈáçÈªûÔºö${result.theme}`;
            const tableData = result.sections.map((s, idx) => {
                const structureFull = `${s.structure}${s.structureDesc ? ` (${s.structureDesc})` : ''}`;
                const timeRange = formatTimeRange(result.sections, idx);
                const cleanAudio = s.content.replace(/\n/g, '  |  '); 
                return `${structureFull}\t${timeRange}\t${cleanAudio}`;
            }).join('\n');

            return `${versionInfo}\n\n${headers}\n${tableData}`;
        };

        // --------------------------------------------------------------------------
        // MAIN COMPONENT
        // --------------------------------------------------------------------------
        function App() {
            const [fileContent, setFileContent] = useState('');
            const [fileName, setFileName] = useState('');
            const [isDragging, setIsDragging] = useState(false);
            const [isProcessing, setIsProcessing] = useState(false);
            const [activeVersion, setActiveVersion] = useState('A');
            
            // ‰øÆÊ≠£Áí∞Â¢ÉËÆäÊï∏ÂèñÂæó (ÁßªÈô§ optional chaining ?.)
            const getEnvApiKey = () => {
                try {
                    if (typeof process !== 'undefined' && process.env && process.env.REACT_APP_GEMINI_API_KEY) {
                        return process.env.REACT_APP_GEMINI_API_KEY;
                    }
                } catch (e) {
                    // Ignore errors
                }
                return '';
            };

            const [apiKey, setApiKey] = useState(HARDCODED_API_KEY || getEnvApiKey());
            const [showSettings, setShowSettings] = useState(false);
            
            const [results, setResults] = useState(null);
            const [sourceSummary, setSourceSummary] = useState(null);
            const [error, setError] = useState(null);
            const [copiedTitle, setCopiedTitle] = useState(null);
            const [isMock, setIsMock] = useState(false);

            // Mock Data Generator
            const generateMockResult = () => {
                const mockSummary = {
                    overview: "ÈÄôÊÆµÂ∞çË©±ÂëàÁèæ‰∫ÜÂÖ∏ÂûãÁöÑ„ÄåÊàÄÊÑõËÖ¶„ÄçËàá„Äå‰∫∫ÈñìÊ∏ÖÈÜí„Äç‰πãÈñìÁöÑËßÄÂøµË°ùÁ™Å„ÄÇ‰∏ªËßí A Â∞çÊñºÁî∑ÊÄßÁöÑÊôÆÈÄöÁ§æ‰∫§Ë°åÁÇ∫ÔºàÂ¶ÇË™™ÊôöÂÆâÔºâÁî¢Áîü‰∫ÜÈÅéÂ∫¶ÁöÑÊµ™Êº´Ëß£ËÆÄÔºåËÄåÊúãÂèã B ÂâáË©¶ÂúñÁî®ÁêÜÊÄßÁöÑËßíÂ∫¶Êà≥Á†¥ÂπªÊÉ≥ÔºåÊåáÂá∫ A ÁöÑË°åÁÇ∫ÂØ¶Èöõ‰∏äÊõ¥ÂÉèÊòØÂñÆÊñπÈù¢ÁöÑ‰ªòÂá∫ÔºàÂ∑•ÂÖ∑‰∫∫Ôºâ„ÄÇÈÄôÊÆµÁ¥†ÊùêÂèçÊò†‰∫ÜÁèæ‰ª£‰∫§Âèã‰∏≠Â∏∏Ë¶ãÁöÑÊ®°Á≥äÁïåÁ∑öËàáËá™ÊàëÊäïÂ∞ÑÂøÉÁêÜ„ÄÇ",
                    tags: ["ÊàÄÊÑõËÖ¶", "Â∑•ÂÖ∑‰∫∫", "Á§æ‰∫§ÈåØË¶∫", "‰∫∫ÈñìÊ∏ÖÈÜí", "ÂÖ©ÊÄß‰∫íÂãï", "ÊöàËàπ"]
                };
                setSourceSummary(mockSummary);

                const sectionsA = [
                    { structure: "Ëµ∑", structureDesc: "ËààÂ•ÆÊöàËàπ", content: `AÔºö„ÄåÂ§©ÂïäÔºÅÈÇ£ÂÄãË∂ÖÂ∏•ÁöÑÁî∑ÁîüÊò®Â§©Á´üÁÑ∂Ë∑üÊàëË™™ÊôöÂÆâËÄ∂ÔºÅ‰ªñÊòØ‰∏çÊòØÂñúÊ≠°ÊàëÔºü„Äç\n\nBÔºö„Äå‰ªñÊòØÊúâÊØõÁóÖÂêßÔºüÊôöÂÆâÂ∞±ÊòØÊÉ≥Áù°Ë¶∫‰∫ÜÔºå‰∏çÁÑ∂Ë¶ÅÁµ¶‰Ω†ÁúãÂÅ•Ê™¢Â†±ÂëäÂóéÔºü„Äç`, visual: "", duration: 10 },
                    { structure: "Êâø", structureDesc: "Â∑•ÂÖ∑‰∫∫Ë°åÁÇ∫", content: `BÔºö„ÄåÈÇ£‰ªñÊúâË≤∑Êó©È§êÁµ¶‰Ω†ÂóéÔºü„Äç\n\nAÔºö„ÄåÊ≤íÊúâÂïäÔºÅ‰ΩÜÊàëÊúâË´ã‰ªñÂñùÈ£≤Êñô„ÄÅÈÇÑÊúâÂπ´‰ªñÂè´ËªäÔºåÂõ†ÁÇ∫‰ªñÂâõÂ•ΩÂè£Ê∏¥ÂèàÊ≤íÈå¢ÂòõÔºÅ„Äç\n\nBÔºö„Äå...‰Ω†ÈÄôÊòØÂÅöÊÖàÂñÑÂêßÔºü‰Ω†ÊòØÊèêÊ¨æÊ©üÂóéÔºü„Äç`, visual: "", duration: 15 },
                    { structure: "ËΩâ", structureDesc: "Áõ≤ÁõÆËá™‰ø°", content: `AÔºö„ÄåÂèØÊòØ‰ªñË™™ÊàëÊòØÊúÄ„ÄéÁâπÂà•„ÄèÁöÑÈÇ£ÂÄãËÄ∂ÔºÅ„Äç\n\nBÔºö„ÄåÂ∞çÔºå„ÄéÁâπÂà•„ÄèÂ•ΩÈ®ôÁöÑÈÇ£ÂÄã„ÄÇ„Äç\n\nAÔºö„Äå‰Ω†‰∏çÊáÇÂï¶ÔºÅÈÄôÊòØÊàëÂÄëÁöÑÈªòÂ•ë„ÄÇ„Äç`, visual: "", duration: 15 },
                    { structure: "Âêà", structureDesc: "ÁÑ°Ëó•ÂèØÊïë", content: `BÔºöÔºàÂ∞çÈè°È†≠Ôºâ„ÄåÊúâÈÄôÁ®ÆÊúãÂèãÔºåÊàëË©≤Â†±Ë≠¶ÈÇÑÊòØÂπ´Â•πÊéõËôüËÖ¶ÁßëÔºü„Äç\n\nAÔºö„ÄåÂìéÂî∑‰ªñÂèàÂÇ≥Ë≤ºÂúñÁµ¶Êàë‰∫ÜÔºÅÈÄôÊòØÊ±ÇÂ©öÊöóÁ§∫ÂóéÔºü„Äç`, visual: "", duration: 10 },
                ];
                
                const processMock = (type, name, title) => {
                    const sections = type === 'B' ? sectionsA.map(s => ({...s, content: s.content.replace("AÔºö", "A(Â∞ñÂè´)Ôºö")})) : sectionsA;
                    const totalDuration = sections.reduce((acc, c) => acc + c.duration, 0);
                    return {
                        title,
                        theme: "Êé¢Ë®éÊàÄÊÑõËÖ¶Ëàá‰∫∫ÈñìÊ∏ÖÈÜíÁöÑÊ•µËá¥ÂèçÂ∑Æ",
                        suggestedTitles: ["ÊöàËàπ‰ªîÂøÖÁúãÔºÅü§°", "‰∫∫ÈñìÊ∏ÖÈÜí vs ÊàÄÊÑõËÖ¶üíî", "Tag‰Ω†ÊúãÂèãüëá", "Â∑•ÂÖ∑‰∫∫ÁöÑ‰∏ãÂ†¥üëã", "Âà•ÂÜçÂÇª‰∫ÜÔºÅüìâ"],
                        versionType: type,
                        versionName: name,
                        totalDuration,
                        sections
                    };
                };

                setResults({
                    A: processMock('A', 'ÁâàÊú¨‰∏ÄÔºöÊÉÖÂ¢ÉÂäáÁâà', '„ÄêÂ∞çË©±ÊÉÖÂ¢É„ÄëÊàÄÊÑõËÖ¶ vs Ê∏ÖÈÜí‰∫∫'),
                    B: processMock('B', 'ÁâàÊú¨‰∫åÔºöÁàÜÊ¨æÂê∏ÁùõÁâà', 'üî• ÊàÄÊÑõËÖ¶ vs Ê∏ÖÈÜí‰∫∫'),
                    Mix: processMock('Mix', 'ÁâàÊú¨‰∏âÔºöÂπ≥Ë°°Á∂úÂêàÁâà', '‚ú® ÊàÄÊÑõËÖ¶ vs Ê∏ÖÈÜí‰∫∫')
                });
                setIsMock(true);
            };

            // AI Generator
            const generateAIResult = async (text) => {
                const prompt = `
                    ‰Ω†ÊòØ‰∏ÄÂÄãÂ∞àÊ•≠ÁöÑÁü≠ÂΩ±Èü≥ËÖ≥Êú¨Â∏´ËàáÂÖßÂÆπÂàÜÊûêÂ∏´„ÄÇË´ãÂàÜÊûê‰ª•‰∏ãÊñáÂ≠óÁ®øÔºåÂÆåÊàêÂÖ©ÂÄã‰ªªÂãôÔºö
                    
                    ‰ªªÂãô‰∏ÄÔºö„Äê‰æÜÊ∫êÂ∞éË¶Ω (Source Guide)„Äë
                    Ê®°‰ªø NotebookLM ÁöÑÈ¢®Ê†ºÔºåÁîüÊàê‰∏ÄÊÆµ 100-150 Â≠óÁöÑ„ÄåÊëòË¶Å (overview)„ÄçÔºåÂÆ¢ËßÄÂú∞Ë™™ÊòéÈÄôÁØáÊñáÁ´†/ÂΩ±ÁâáÂú®Ë¨õ‰ªÄÈ∫º„ÄÅÊ†∏ÂøÉË°ùÁ™ÅÊàñÁü•Ë≠òÈªûÁÇ∫‰Ωï„ÄÇ‰∏¶ÊèêÂèñ 5-8 ÂÄãÈóúÈçµÂ≠ó (tags)„ÄÇ

                    ‰ªªÂãô‰∫åÔºö„ÄêËÖ≥Êú¨ÁîüÊàê„Äë
                    Â∞áÂÖßÂÆπÊîπÂØ´ÁÇ∫„ÄêÈõô‰∫∫Â∞çË©± / ÊÉÖÂ¢ÉÂäá (Skit)„ÄëÈ¢®Ê†ºÁöÑËÖ≥Êú¨ÔºåÁîüÊàê‰∏âÂÄãÁâàÊú¨ (A/B/Mix)ÔºåÁ∏ΩÊôÇÈï∑Á¥Ñ 40-50 Áßí„ÄÇ
                    
                    Ëº∏ÂÖ•ÊñáÂ≠ó:
                    """
                    ${text.substring(0, 15000)} 
                    """
                    
                    Ë´ãÂõûÂÇ≥Âö¥Ê†ºÁöÑ JSON Ê†ºÂºè:
                    {
                        "source_summary": {
                        "overview": "ÈÄôÊÆµÂÖßÂÆπ‰∏ªË¶ÅÂú®Êé¢Ë®é...",
                        "tags": ["ÈóúÈçµÂ≠ó1", "ÈóúÈçµÂ≠ó2", ...]
                        },
                        "scripts": {
                        "A": {
                            "title": "Ê®ôÈ°å",
                            "theme": "‰∏ÄÂè•Ë©±ÈáçÈªû",
                            "suggested_titles": ["IGÊ®ôÈ°å1", "IGÊ®ôÈ°å2"],
                            "sections": [
                            {"structure": "Ëµ∑", "structureDesc": "...", "content": "A: ...\\nB: ...", "visual": "..."}
                            ]
                        },
                        "B": { ... },
                        "Mix": { ... }
                        }
                    }
                `;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });

                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    
                    // ‰øÆÊ≠£: ÁßªÈô§ optional chaining ?.ÔºåÊîπÁî®ÂÇ≥Áµ± && Ê™¢Êü•
                    if (!data.candidates || !data.candidates[0] || !data.candidates[0].content || !data.candidates[0].content.parts || !data.candidates[0].content.parts[0] || !data.candidates[0].content.parts[0].text) {
                        throw new Error("AI ÂõûÂÇ≥Ë≥áÊñôÁï∞Â∏∏ÔºåË´ãÈáçË©¶");
                    }

                    const rawText = data.candidates[0].content.parts[0].text;
                    const jsonText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                    const parsed = JSON.parse(jsonText);

                    setSourceSummary(parsed.source_summary);

                    const processVersion = (v, type, name) => {
                        const sections = v.sections.map((s) => ({
                            ...s,
                            duration: estimateDuration(s.content)
                        }));
                        return {
                            title: v.title,
                            theme: v.theme,
                            suggestedTitles: v.suggested_titles || [],
                            versionType: type,
                            versionName: name,
                            sections,
                            totalDuration: sections.reduce((acc, cur) => acc + cur.duration, 0)
                        };
                    };

                    setResults({
                        A: processVersion(parsed.scripts.A, 'A', 'ÁâàÊú¨‰∏ÄÔºöÂ∞çË©±ÊÉÖÂ¢ÉÁâà'),
                        B: processVersion(parsed.scripts.B, 'B', 'ÁâàÊú¨‰∫åÔºöÁàÜÊ¨æÂêêÊßΩÁâà'),
                        Mix: processVersion(parsed.scripts.Mix, 'Mix', 'ÁâàÊú¨‰∏âÔºöÂπ≥Ë°°Á∂úÂêàÁâà')
                    });
                    setIsMock(false);

                } catch (e) {
                    console.error(e);
                    throw new Error(e.message || "AI ÁîüÊàêÂ§±Êïó");
                }
            };

            const handleAnalyze = async () => {
                if (!fileContent.trim()) {
                    setError("Ë´ãÂÖàËº∏ÂÖ•ÂÖßÂÆπÊàñ‰∏äÂÇ≥Ê™îÊ°à");
                    return;
                }
                setIsProcessing(true);
                setError(null);
                setResults(null); 
                setSourceSummary(null);

                try {
                    if (apiKey && apiKey.length > 10) {
                        await generateAIResult(fileContent);
                    } else {
                        await new Promise(resolve => setTimeout(resolve, 1500));
                        generateMockResult();
                    }
                } catch (err) {
                    setError(err.message || "ËôïÁêÜÊôÇÁôºÁîüÈåØË™§");
                } finally {
                    setIsProcessing(false);
                }
            };

            const copyToClipboard = (text) => {
                const el = document.createElement('textarea');
                el.value = text;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
            };

            const handleCopyTitle = (title) => {
                copyToClipboard(title);
                setCopiedTitle(title);
                setTimeout(() => setCopiedTitle(null), 2000);
            };
            
            const handleCopyAll = () => {
                if (!results) return;
                
                let summaryText = "";
                if (sourceSummary) {
                    summaryText = `„Äê‰æÜÊ∫êÂ∞éË¶Ω„Äë\nÊëòË¶ÅÔºö${sourceSummary.overview}\nÈóúÈçµÂ≠óÔºö${sourceSummary.tags.join(', ')}\n\n========================================\n\n`;
                }

                const allText = [
                    summaryText,
                    generateCopyString(results.A),
                    '----------------------------------------',
                    generateCopyString(results.B),
                    '----------------------------------------',
                    generateCopyString(results.Mix)
                ].join('\n\n');
                copyToClipboard(allText);
            };

            const handleFileSelect = (e) => {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        setFileContent(ev.target.result);
                        setFileName(e.target.files[0].name);
                        setError(null);
                    };
                    reader.readAsText(e.target.files[0]);
                }
            };
            
            const handleDrop = (e) => {
                e.preventDefault();
                setIsDragging(false);
                const file = e.dataTransfer.files[0];
                if (file && file.type === 'text/plain') {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        setFileContent(ev.target.result);
                        setFileName(file.name);
                        setError(null);
                    };
                    reader.readAsText(file);
                } else {
                    setError('Ë´ã‰∏äÂÇ≥ .txt ÊñáÂ≠óÊ™îÊ°à');
                }
            };

            const currentResult = results ? results[activeVersion] : null;

            return (
                <div className="pb-20">
                    {/* Header */}
                    <header className="border-b border-gray-800 bg-gray-900/50 backdrop-blur-md sticky top-0 z-10">
                        <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <div className="bg-gradient-to-tr from-indigo-500 to-purple-500 p-2 rounded-lg">
                                    <LucideIcon name="Users" size={20} className="text-white" />
                                </div>
                                <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">
                                    Ê•µÈÄüËÖ≥Êú¨Â§ßÂ∏´ <span className="text-xs font-normal text-gray-500 px-2 border border-gray-700 rounded-full">Pro</span>
                                </h1>
                            </div>
                            
                            <div className="flex items-center gap-3">
                                <div className="hidden md:flex items-center gap-1.5 px-3 py-1 rounded-full bg-gray-800 border border-gray-700 text-xs">
                                    {apiKey ? (
                                        <>
                                            <div className="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"></div>
                                            <span className="text-gray-300">Gemini AI Â∞±Á∑í</span>
                                        </>
                                    ) : (
                                        <>
                                            <div className="w-2 h-2 rounded-full bg-yellow-500"></div>
                                            <span className="text-gray-400">ÊºîÁ§∫Ê®°Âºè</span>
                                        </>
                                    )}
                                </div>

                                <button 
                                    onClick={() => setShowSettings(!showSettings)}
                                    className={`p-2 rounded-full transition-colors ${showSettings ? 'bg-indigo-600 text-white' : 'hover:bg-gray-800 text-gray-400'}`}
                                    title="API Ë®≠ÂÆö"
                                >
                                    <LucideIcon name="Settings" size={20} />
                                </button>
                            </div>
                        </div>
                        
                        {/* Settings Panel */}
                        {showSettings && (
                            <div className="bg-gray-800 border-b border-gray-700 p-4 animate-in">
                                <div className="max-w-6xl mx-auto flex flex-col md:flex-row gap-6">
                                    <div className="flex-1 w-full space-y-3">
                                        <div className="flex items-center gap-2 text-indigo-400 mb-1">
                                            <LucideIcon name="Key" size={16} />
                                            <label className="text-sm font-bold">Google Gemini API Key</label>
                                        </div>
                                        <div className="relative">
                                            <input 
                                                type="password" 
                                                value={apiKey}
                                                onChange={(e) => setApiKey(e.target.value)}
                                                placeholder="Ëº∏ÂÖ•ÊÇ®ÁöÑ AIzaSy..."
                                                className="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all placeholder:text-gray-600"
                                            />
                                        </div>
                                        <p className="text-xs text-gray-500">
                                            Ëã•Êú™Ëº∏ÂÖ• KeyÔºåÁ≥ªÁµ±Â∞á‰ΩøÁî® <strong>ÊºîÁ§∫Ê®°Âºè (Mock Data)</strong> ‰æÜÂ±ïÁ§∫‰ªãÈù¢ÊïàÊûú„ÄÇ
                                        </p>
                                    </div>
                                </div>
                            </div>
                        )}
                    </header>

                    <main className="max-w-6xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
                        
                        {/* Left Column: Input */}
                        <div className="space-y-6">
                            <div className="flex items-center justify-between">
                                <h2 className="text-lg font-semibold flex items-center gap-2">
                                    <LucideIcon name="FileText" size={20} className="text-indigo-400" />
                                    ÂéüÂßãÁ¥†Êùê
                                </h2>
                                {fileContent && (
                                    <button 
                                        onClick={() => {setFileContent(''); setFileName(''); setResults(null); setSourceSummary(null);}}
                                        className="text-xs text-red-400 hover:text-red-300"
                                    >
                                        Ê∏ÖÈô§ÂÖßÂÆπ
                                    </button>
                                )}
                            </div>

                            <div 
                                className={`
                                    relative group border-2 border-dashed rounded-xl transition-all duration-300 h-[500px] flex flex-col
                                    ${isDragging ? 'border-indigo-500 bg-indigo-500/10' : 'border-gray-700 bg-gray-800/50 hover:border-gray-600'}
                                `}
                                onDragOver={(e) => {e.preventDefault(); setIsDragging(true);}}
                                onDragLeave={() => setIsDragging(false)}
                                onDrop={handleDrop}
                            >
                                {!fileContent ? (
                                    <div className="flex-1 flex flex-col items-center justify-center p-8 text-center">
                                        <div className="w-16 h-16 bg-gray-700 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                                            <LucideIcon name="Upload" size={32} className="text-gray-400" />
                                        </div>
                                        <h3 className="text-lg font-medium text-gray-200 mb-2">ÊãñÊîæ .txt Ê™îÊ°àËá≥Ê≠§</h3>
                                        <p className="text-sm text-gray-500 mb-6">ÊàñÁõ¥Êé•Ë≤º‰∏äÊñáÂ≠óÂÖßÂÆπ</p>
                                        <label className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg cursor-pointer transition-colors shadow-lg shadow-indigo-600/20">
                                            ÈÅ∏ÊìáÊ™îÊ°à
                                            <input type="file" className="hidden" accept=".txt" onChange={handleFileSelect} />
                                        </label>
                                    </div>
                                ) : (
                                    <div className="flex-1 flex flex-col p-4">
                                        <div className="flex items-center justify-between mb-2 text-xs text-gray-400">
                                            <span className="truncate max-w-[200px]">{fileName || 'ÊâãÂãïËº∏ÂÖ•'}</span>
                                            <span>{fileContent.length} Â≠ó</span>
                                        </div>
                                        <textarea 
                                            className="flex-1 w-full bg-transparent resize-none focus:outline-none text-gray-300 text-sm leading-relaxed"
                                            value={fileContent}
                                            onChange={(e) => setFileContent(e.target.value)}
                                            placeholder="Âú®Ê≠§Á∑®ËºØÊàñË≤º‰∏äÊñáÂ≠ó..."
                                        />
                                    </div>
                                )}
                                
                                <div className="p-4 border-t border-gray-700 bg-gray-800 rounded-b-xl">
                                    <button
                                        onClick={handleAnalyze}
                                        disabled={isProcessing || !fileContent}
                                        className={`
                                            w-full py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-all
                                            ${isProcessing || !fileContent 
                                                ? 'bg-gray-700 text-gray-500 cursor-not-allowed' 
                                                : 'bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white shadow-lg shadow-indigo-900/50'}
                                        `}
                                    >
                                        {isProcessing ? (
                                            <>
                                                <LucideIcon name="RefreshCw" size={20} className="animate-spin mr-2" />
                                                Ê≠£Âú®ÂàÜÊûêËàáÁîüÊàê...
                                            </>
                                        ) : (
                                            <>
                                                <LucideIcon name="Zap" size={20} className="mr-2" />
                                                {apiKey ? "ÈñãÂßãÁîüÊàê (Gemini AI)" : "ÈñãÂßãÁîüÊàê (ÊºîÁ§∫Ê®°Âºè)"}
                                            </>
                                        )}
                                    </button>
                                </div>
                            </div>

                            {error && (
                                <div className="flex items-center gap-2 text-red-400 bg-red-900/20 p-3 rounded-lg text-sm border border-red-900/50 animate-in">
                                    <LucideIcon name="AlertCircle" size={16} />
                                    {error}
                                </div>
                            )}
                        </div>

                        {/* Right Column: Output */}
                        <div className="space-y-6">
                            <h2 className="text-lg font-semibold flex items-center gap-2">
                                <LucideIcon name="LayoutTemplate" size={20} className="text-purple-400" />
                                ÂàÜÊûêÁµêÊûú
                            </h2>

                            {!currentResult ? (
                                <div className="h-[500px] border border-gray-800 rounded-xl bg-gray-800/30 flex flex-col items-center justify-center text-gray-600">
                                    <div className="p-4 rounded-full bg-gray-800 mb-4">
                                        <LucideIcon name="Clock" size={32} className="opacity-50" />
                                    </div>
                                    <p>Á≠âÂæÖÂàÜÊûê...</p>
                                    <p className="text-sm mt-2 opacity-50">Ë´ã‰∏äÂÇ≥ÊñáÂ≠ó‰∏¶ÈªûÊìäÁîüÊàê</p>
                                </div>
                            ) : (
                                <div className="flex flex-col h-full space-y-6 animate-in">
                                    
                                    {/* NotebookLM Style Source Guide Card */}
                                    {sourceSummary && (
                                        <div className="bg-[#1e1e1e] rounded-xl border border-gray-700/50 p-5 shadow-2xl relative overflow-hidden group">
                                            <div className="absolute top-0 right-0 w-64 h-64 bg-indigo-500/10 rounded-full blur-3xl -mr-32 -mt-32 pointer-events-none"></div>
                                            
                                            <div className="flex items-center gap-2 mb-3 text-indigo-400">
                                                <LucideIcon name="Sparkles" size={18} />
                                                <h3 className="font-bold text-sm tracking-wide uppercase">‰æÜÊ∫êÂ∞éË¶Ω (Source Guide)</h3>
                                            </div>
                                            
                                            <div className="relative z-10">
                                                <p className="text-gray-300 text-sm leading-relaxed mb-4">
                                                    {sourceSummary.overview}
                                                </p>
                                                <div className="flex flex-wrap gap-2">
                                                    {sourceSummary.tags.map((tag, i) => (
                                                        <span key={i} className="px-3 py-1 bg-gray-800 hover:bg-gray-700 text-gray-400 text-xs rounded-full border border-gray-700 transition-colors cursor-default">
                                                            #{tag}
                                                        </span>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Scripts Section */}
                                    <div className="space-y-4">
                                        {/* Version Tabs */}
                                        <div className="flex p-1 bg-gray-800 rounded-lg">
                                            <button 
                                                onClick={() => setActiveVersion('A')}
                                                className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${activeVersion === 'A' ? 'bg-indigo-600 text-white shadow' : 'text-gray-400 hover:text-white'}`}
                                            >
                                                ÁâàÊú¨‰∏Ä (A)
                                            </button>
                                            <button 
                                                onClick={() => setActiveVersion('B')}
                                                className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${activeVersion === 'B' ? 'bg-pink-600 text-white shadow' : 'text-gray-400 hover:text-white'}`}
                                            >
                                                ÁâàÊú¨‰∫å (B)
                                            </button>
                                            <button 
                                                onClick={() => setActiveVersion('Mix')}
                                                className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${activeVersion === 'Mix' ? 'bg-purple-600 text-white shadow' : 'text-gray-400 hover:text-white'}`}
                                            >
                                                ÁâàÊú¨‰∏â (Mix)
                                            </button>
                                        </div>

                                        {isMock && (
                                            <div className="bg-yellow-900/30 border border-yellow-700/50 text-yellow-200 text-xs p-3 rounded-lg flex items-center gap-2">
                                                <LucideIcon name="Info" size={16} className="text-yellow-400" />
                                                <span>ÊºîÁ§∫Ê®°ÂºèÔºöÊ≠§ÁÇ∫Ê®°Êì¨Ë≥áÊñô„ÄÇË´ãËº∏ÂÖ• API Key ‰ª•Áç≤ÂæóÁúüÂØ¶ÂàÜÊûê„ÄÇ</span>
                                            </div>
                                        )}

                                        {/* The "Paper" */}
                                        <div className="bg-white rounded-lg shadow-xl overflow-hidden flex flex-col text-gray-900 font-sans border border-gray-300">
                                            {/* Blue Header Bar */}
                                            <div className="bg-[#004e98] text-white p-3 flex justify-between items-center">
                                                <div className="font-bold text-lg tracking-wide truncate pr-4">
                                                    {currentResult.versionName}: „Äê{currentResult.title}„Äë
                                                </div>
                                                <div className="text-xs bg-white/20 px-2 py-1 rounded whitespace-nowrap">
                                                    Á∏ΩÊôÇÈï∑: {currentResult.totalDuration}s
                                                </div>
                                            </div>

                                            {/* Key Point Summary */}
                                            <div className="bg-white p-4 text-center">
                                                <p className="text-gray-800 font-medium">
                                                    <span className="font-bold text-[#004e98] mr-2">ÈáçÈªû:</span>
                                                    {currentResult.theme}
                                                </p>
                                            </div>

                                            {/* IG Titles Section */}
                                            {currentResult.suggestedTitles && currentResult.suggestedTitles.length > 0 && (
                                                <div className="bg-gradient-to-r from-pink-50 to-purple-50 p-4 border-t border-b border-gray-200">
                                                    <h4 className="text-xs font-bold text-gray-500 uppercase mb-3 flex items-center gap-1.5">
                                                        <LucideIcon name="Instagram" size={14} className="text-pink-600" />
                                                        IG Reels Âê∏ÁùõÊ®ôÈ°åÂª∫Ë≠∞ (ÈªûÊìäË§áË£Ω)
                                                    </h4>
                                                    <div className="flex flex-wrap gap-2">
                                                        {currentResult.suggestedTitles.map((t, i) => (
                                                            <button 
                                                                key={i} 
                                                                onClick={() => handleCopyTitle(t)}
                                                                className={`
                                                                    px-3 py-1.5 rounded-full text-sm font-medium border shadow-sm transition-all
                                                                    ${copiedTitle === t 
                                                                        ? 'bg-green-100 border-green-300 text-green-700 scale-105' 
                                                                        : 'bg-white border-gray-200 text-gray-700 hover:border-pink-300 hover:text-pink-600 hover:bg-pink-50'
                                                                    }
                                                                `}
                                                            >
                                                                {copiedTitle === t ? 'Â∑≤Ë§áË£Ω! ‚úÖ' : t}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}

                                            {/* Table Header */}
                                            <div className="grid grid-cols-12 border-b border-gray-300 bg-gray-50 text-sm font-bold text-gray-600">
                                                <div className="col-span-3 p-3 border-r border-gray-200 text-center flex items-center justify-center">ÁµêÊßã</div>
                                                <div className="col-span-2 p-3 border-r border-gray-200 text-center flex items-center justify-center">ÊôÇÈñì‰ΩîÊØî</div>
                                                <div className="col-span-7 p-3 text-center flex items-center justify-center">ËÖ≥Êú¨/Â∞çÁôΩÈáçÈªû (Audio)</div>
                                            </div>

                                            {/* Table Body */}
                                            <div className="overflow-auto max-h-[500px]">
                                                {currentResult.sections.map((section, idx) => (
                                                    <div key={idx} className="grid grid-cols-12 border-b border-gray-200 text-sm hover:bg-gray-50 transition-colors">
                                                        <div className="col-span-3 p-3 border-r border-gray-200 font-bold text-gray-700 flex flex-col justify-center items-center text-center bg-gray-50/50">
                                                            <span className="text-lg text-[#004e98]">{section.structure}</span>
                                                            {section.structureDesc && (
                                                                <span className="text-xs text-gray-500 mt-1 font-normal break-words px-1">({section.structureDesc})</span>
                                                            )}
                                                        </div>
                                                        
                                                        <div className="col-span-2 p-3 border-r border-gray-200 flex items-center justify-center text-gray-600 font-mono text-center">
                                                            {formatTimeRange(currentResult.sections, idx)}
                                                        </div>

                                                        <div className="col-span-7 p-3 text-gray-800 leading-relaxed font-medium whitespace-pre-wrap">
                                                            {section.content}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>

                                            {/* Footer / Actions */}
                                            <div className="p-3 bg-gray-100 border-t border-gray-300 flex justify-end gap-2">
                                                <button 
                                                    onClick={handleCopyAll}
                                                    className="flex items-center gap-2 px-4 py-2 bg-purple-700 hover:bg-purple-600 text-white rounded shadow-sm text-sm transition-colors"
                                                >
                                                    <LucideIcon name="Files" size={16} />
                                                    Ë§áË£ΩÊâÄÊúâ (Âê´‰æÜÊ∫ê)
                                                </button>
                                                <button 
                                                    onClick={() => {
                                                        const copyString = generateCopyString(currentResult);
                                                        copyToClipboard(copyString);
                                                    }}
                                                    className="flex items-center gap-2 px-4 py-2 bg-[#004e98] hover:bg-[#003d7a] text-white rounded shadow-sm text-sm transition-colors"
                                                >
                                                    <LucideIcon name="Table" size={16} />
                                                    Ë§áË£ΩÊ≠§ËÖ≥Êú¨
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                    </main>
                </div>
            );
        }

        // Render App
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
