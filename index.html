import React, { useState, useEffect, useRef } from 'react';
import { 
  Upload, 
  FileText, 
  Clock, 
  CheckCircle, 
  RefreshCw, 
  Copy, 
  Settings, 
  Zap, 
  LayoutTemplate, 
  Edit3,
  Video,
  AlertCircle,
  Table,
  Mic,
  Users,
  Instagram,
  Shield,
  Key,
  Info,
  Files,
  Sparkles,
  BookOpen
} from 'lucide-react';

// --------------------------------------------------------------------------
// Configuration & Environment
// --------------------------------------------------------------------------
const getEnvApiKey = () => {
  try {
    if (typeof process !== 'undefined' && process.env?.REACT_APP_GEMINI_API_KEY) {
      return process.env.REACT_APP_GEMINI_API_KEY;
    }
  } catch (e) {}
  return '';
};

const ENV_API_KEY = getEnvApiKey();
const GEMINI_MODEL = "gemini-1.5-flash";

// Types
interface ScriptSection {
  structure: string; 
  structureDesc?: string; 
  content: string; 
  visual: string;
  duration: number; 
}

interface ScriptResult {
  title: string;
  theme: string; 
  suggestedTitles: string[]; 
  totalDuration: number;
  sections: ScriptSection[];
  versionType: 'A' | 'B' | 'Mix';
  versionName: string;
}

// New Interface for Summary
interface SourceSummary {
  overview: string;
  tags: string[];
}

// Helper to estimate reading time
const estimateDuration = (text: string) => {
  const charCount = text.replace(/\s/g, '').length;
  return Math.ceil(charCount / 4.5);
};

const formatTimeRange = (sections: ScriptSection[], currentIndex: number) => {
  let startTime = 0;
  for (let i = 0; i < currentIndex; i++) {
    startTime += sections[i].duration;
  }
  const endTime = startTime + sections[currentIndex].duration;
  return `${startTime}-${endTime}ç§’`;
};

const generateCopyString = (result: ScriptResult) => {
  const headers = "çµæ§‹\tæ™‚é–“ä½”æ¯”\tè…³æœ¬/å°ç™½é‡é» (Audio)";
  const versionInfo = `ç‰ˆæœ¬ï¼š${result.versionName} (${result.versionType})\nä¸»é¡Œåç¨±ï¼š${result.title}\né‡é»ï¼š${result.theme}`;
  const tableData = result.sections.map((s, idx) => {
      const structureFull = `${s.structure}${s.structureDesc ? ` (${s.structureDesc})` : ''}`;
      const timeRange = formatTimeRange(result.sections, idx);
      const cleanAudio = s.content.replace(/\n/g, '  |  '); 
      return `${structureFull}\t${timeRange}\t${cleanAudio}`;
  }).join('\n');
  return `${versionInfo}\n\n${headers}\n${tableData}`;
};

export default function App() {
  const [fileContent, setFileContent] = useState<string>('');
  const [fileName, setFileName] = useState<string>('');
  const [isDragging, setIsDragging] = useState(false);
  const [isProcessing, setIsProcessing] = useState(false);
  const [activeVersion, setActiveVersion] = useState<'A' | 'B' | 'Mix'>('A');
  
  const [apiKey, setApiKey] = useState(ENV_API_KEY);
  const [showSettings, setShowSettings] = useState(false);
  
  const [results, setResults] = useState<Record<string, ScriptResult> | null>(null);
  const [sourceSummary, setSourceSummary] = useState<SourceSummary | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [copiedTitle, setCopiedTitle] = useState<string | null>(null);
  const [isMock, setIsMock] = useState(false);

  // File Upload Handlers
  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault();
    setIsDragging(true);
  };

  const handleDragLeave = () => setIsDragging(false);

  const handleDrop = async (e: React.DragEvent) => {
    e.preventDefault();
    setIsDragging(false);
    const file = e.dataTransfer.files[0];
    if (file && file.type === 'text/plain') {
      readFile(file);
    } else {
      setError('è«‹ä¸Šå‚³ .txt æ–‡å­—æª”æ¡ˆ');
    }
  };

  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) {
      readFile(e.target.files[0]);
    }
  };

  const readFile = (file: File) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const text = e.target?.result as string;
      setFileContent(text);
      setFileName(file.name);
      setError(null);
    };
    reader.readAsText(file);
  };

  // --------------------------------------------------------------------------
  // AI / MOCK LOGIC
  // --------------------------------------------------------------------------

  const generateMockResult = () => {
    // Mock Summary
    const mockSummary: SourceSummary = {
      overview: "é€™æ®µå°è©±å‘ˆç¾äº†å…¸å‹çš„ã€Œæˆ€æ„›è…¦ã€èˆ‡ã€Œäººé–“æ¸…é†’ã€ä¹‹é–“çš„è§€å¿µè¡çªã€‚ä¸»è§’ A å°æ–¼ç”·æ€§çš„æ™®é€šç¤¾äº¤è¡Œç‚ºï¼ˆå¦‚èªªæ™šå®‰ï¼‰ç”¢ç”Ÿäº†éåº¦çš„æµªæ¼«è§£è®€ï¼Œè€Œæœ‹å‹ B å‰‡è©¦åœ–ç”¨ç†æ€§çš„è§’åº¦æˆ³ç ´å¹»æƒ³ï¼ŒæŒ‡å‡º A çš„è¡Œç‚ºå¯¦éš›ä¸Šæ›´åƒæ˜¯å–®æ–¹é¢çš„ä»˜å‡ºï¼ˆå·¥å…·äººï¼‰ã€‚é€™æ®µç´ æåæ˜ äº†ç¾ä»£äº¤å‹ä¸­å¸¸è¦‹çš„æ¨¡ç³Šç•Œç·šèˆ‡è‡ªæˆ‘æŠ•å°„å¿ƒç†ã€‚",
      tags: ["æˆ€æ„›è…¦", "å·¥å…·äºº", "ç¤¾äº¤éŒ¯è¦º", "äººé–“æ¸…é†’", "å…©æ€§äº’å‹•", "æšˆèˆ¹"]
    };
    setSourceSummary(mockSummary);

    // Mock Scripts
    const sectionsA: ScriptSection[] = [
      { structure: "èµ·", structureDesc: "èˆˆå¥®æšˆèˆ¹", content: `Aï¼šã€Œå¤©å•Šï¼é‚£å€‹è¶…å¸¥çš„ç”·ç”Ÿæ˜¨å¤©ç«Ÿç„¶è·Ÿæˆ‘èªªæ™šå®‰è€¶ï¼ä»–æ˜¯ä¸æ˜¯å–œæ­¡æˆ‘ï¼Ÿã€\n\nBï¼šã€Œä»–æ˜¯æœ‰æ¯›ç—…å§ï¼Ÿæ™šå®‰å°±æ˜¯æƒ³ç¡è¦ºäº†ï¼Œä¸ç„¶è¦çµ¦ä½ çœ‹å¥æª¢å ±å‘Šå—ï¼Ÿã€`, visual: "", duration: 10 },
      { structure: "æ‰¿", structureDesc: "å·¥å…·äººè¡Œç‚º", content: `Bï¼šã€Œé‚£ä»–æœ‰è²·æ—©é¤çµ¦ä½ å—ï¼Ÿã€\n\nAï¼šã€Œæ²’æœ‰å•Šï¼ä½†æˆ‘æœ‰è«‹ä»–å–é£²æ–™ã€é‚„æœ‰å¹«ä»–å«è»Šï¼Œå› ç‚ºä»–å‰›å¥½å£æ¸´åˆæ²’éŒ¢å˜›ï¼ã€\n\nBï¼šã€Œ...ä½ é€™æ˜¯åšæ…ˆå–„å§ï¼Ÿä½ æ˜¯ææ¬¾æ©Ÿå—ï¼Ÿã€`, visual: "", duration: 15 },
      { structure: "è½‰", structureDesc: "ç›²ç›®è‡ªä¿¡", content: `Aï¼šã€Œå¯æ˜¯ä»–èªªæˆ‘æ˜¯æœ€ã€ç‰¹åˆ¥ã€çš„é‚£å€‹è€¶ï¼ã€\n\nBï¼šã€Œå°ï¼Œã€ç‰¹åˆ¥ã€å¥½é¨™çš„é‚£å€‹ã€‚ã€\n\nAï¼šã€Œä½ ä¸æ‡‚å•¦ï¼é€™æ˜¯æˆ‘å€‘çš„é»˜å¥‘ã€‚ã€`, visual: "", duration: 15 },
      { structure: "åˆ", structureDesc: "ç„¡è—¥å¯æ•‘", content: `Bï¼šï¼ˆå°é¡é ­ï¼‰ã€Œæœ‰é€™ç¨®æœ‹å‹ï¼Œæˆ‘è©²å ±è­¦é‚„æ˜¯å¹«å¥¹æ›è™Ÿè…¦ç§‘ï¼Ÿã€\n\nAï¼šã€Œå“å”·ä»–åˆå‚³è²¼åœ–çµ¦æˆ‘äº†ï¼é€™æ˜¯æ±‚å©šæš—ç¤ºå—ï¼Ÿã€`, visual: "", duration: 10 },
    ];
    
    // ... rest of mock logic similar to previous ...
    const processMock = (type: 'A' | 'B' | 'Mix', name: string, title: string) => {
       const sections = type === 'B' ? sectionsA.map(s => ({...s, content: s.content.replace("Aï¼š", "A(å°–å«)ï¼š")})) : sectionsA;
       const totalDuration = sections.reduce((acc, c) => acc + c.duration, 0);
       return {
         title,
         theme: "æ¢è¨æˆ€æ„›è…¦èˆ‡äººé–“æ¸…é†’çš„æ¥µè‡´åå·®",
         suggestedTitles: ["æšˆèˆ¹ä»”å¿…çœ‹ï¼ğŸ¤¡", "äººé–“æ¸…é†’ vs æˆ€æ„›è…¦ğŸ’”", "Tagä½ æœ‹å‹ğŸ‘‡", "å·¥å…·äººçš„ä¸‹å ´ğŸ‘‹", "åˆ¥å†å‚»äº†ï¼ğŸ“‰"],
         versionType: type,
         versionName: name,
         totalDuration,
         sections
       };
    };

    setResults({
      A: processMock('A', 'ç‰ˆæœ¬ä¸€ï¼šæƒ…å¢ƒåŠ‡ç‰ˆ', 'ã€å°è©±æƒ…å¢ƒã€‘æˆ€æ„›è…¦ vs æ¸…é†’äºº'),
      B: processMock('B', 'ç‰ˆæœ¬äºŒï¼šçˆ†æ¬¾å¸ç›ç‰ˆ', 'ğŸ”¥ æˆ€æ„›è…¦ vs æ¸…é†’äºº'),
      Mix: processMock('Mix', 'ç‰ˆæœ¬ä¸‰ï¼šå¹³è¡¡ç¶œåˆç‰ˆ', 'âœ¨ æˆ€æ„›è…¦ vs æ¸…é†’äºº')
    });
    setIsMock(true);
  };

  const generateAIResult = async (text: string) => {
    const prompt = `
      ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„çŸ­å½±éŸ³è…³æœ¬å¸«èˆ‡å…§å®¹åˆ†æå¸«ã€‚è«‹åˆ†æä»¥ä¸‹æ–‡å­—ç¨¿ï¼Œå®Œæˆå…©å€‹ä»»å‹™ï¼š
      
      ä»»å‹™ä¸€ï¼šã€ä¾†æºå°è¦½ (Source Guide)ã€‘
      æ¨¡ä»¿ NotebookLM çš„é¢¨æ ¼ï¼Œç”Ÿæˆä¸€æ®µ 100-150 å­—çš„ã€Œæ‘˜è¦ (overview)ã€ï¼Œå®¢è§€åœ°èªªæ˜é€™ç¯‡æ–‡ç« /å½±ç‰‡åœ¨è¬›ä»€éº¼ã€æ ¸å¿ƒè¡çªæˆ–çŸ¥è­˜é»ç‚ºä½•ã€‚ä¸¦æå– 5-8 å€‹é—œéµå­— (tags)ã€‚

      ä»»å‹™äºŒï¼šã€è…³æœ¬ç”Ÿæˆã€‘
      å°‡å…§å®¹æ”¹å¯«ç‚ºã€é›™äººå°è©± / æƒ…å¢ƒåŠ‡ (Skit)ã€‘é¢¨æ ¼çš„è…³æœ¬ï¼Œç”Ÿæˆä¸‰å€‹ç‰ˆæœ¬ (A/B/Mix)ï¼Œç¸½æ™‚é•·ç´„ 40-50 ç§’ã€‚
      
      è¼¸å…¥æ–‡å­—:
      """
      ${text.substring(0, 15000)} 
      """
      
      è«‹å›å‚³åš´æ ¼çš„ JSON æ ¼å¼:
      {
        "source_summary": {
          "overview": "é€™æ®µå…§å®¹ä¸»è¦åœ¨æ¢è¨...",
          "tags": ["é—œéµå­—1", "é—œéµå­—2", ...]
        },
        "scripts": {
          "A": {
            "title": "æ¨™é¡Œ",
            "theme": "ä¸€å¥è©±é‡é»",
            "suggested_titles": ["IGæ¨™é¡Œ1", "IGæ¨™é¡Œ2"],
            "sections": [
              {"structure": "èµ·", "structureDesc": "...", "content": "A: ...\\nB: ...", "visual": "..."}
            ]
          },
          "B": { ... },
          "Mix": { ... }
        }
      }
    `;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });

      const data = await response.json();
      if (data.error) throw new Error(data.error.message);
      
      const rawText = data.candidates[0].content.parts[0].text;
      const jsonText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
      const parsed = JSON.parse(jsonText);

      setSourceSummary(parsed.source_summary);

      const processVersion = (v: any, type: string, name: string): ScriptResult => {
        const sections = v.sections.map((s: any) => ({
          ...s,
          duration: estimateDuration(s.content)
        }));
        return {
          title: v.title,
          theme: v.theme,
          suggestedTitles: v.suggested_titles || [],
          versionType: type as any,
          versionName: name,
          sections,
          totalDuration: sections.reduce((acc: number, cur: any) => acc + cur.duration, 0)
        };
      };

      setResults({
        A: processVersion(parsed.scripts.A, 'A', 'ç‰ˆæœ¬ä¸€ï¼šå°è©±æƒ…å¢ƒç‰ˆ'),
        B: processVersion(parsed.scripts.B, 'B', 'ç‰ˆæœ¬äºŒï¼šçˆ†æ¬¾åæ§½ç‰ˆ'),
        Mix: processVersion(parsed.scripts.Mix, 'Mix', 'ç‰ˆæœ¬ä¸‰ï¼šå¹³è¡¡ç¶œåˆç‰ˆ')
      });
      setIsMock(false);

    } catch (e: any) {
      console.error(e);
      throw new Error(e.message || "AI ç”Ÿæˆå¤±æ•—");
    }
  };

  const handleAnalyze = async () => {
    if (!fileContent.trim()) {
      setError("è«‹å…ˆè¼¸å…¥å…§å®¹æˆ–ä¸Šå‚³æª”æ¡ˆ");
      return;
    }
    setIsProcessing(true);
    setError(null);
    setResults(null); // Clear previous results
    setSourceSummary(null);

    try {
      if (apiKey && apiKey.length > 10) {
        await generateAIResult(fileContent);
      } else {
        await new Promise(resolve => setTimeout(resolve, 1500));
        generateMockResult();
      }
    } catch (err: any) {
      setError(err.message || "è™•ç†æ™‚ç™¼ç”ŸéŒ¯èª¤");
    } finally {
      setIsProcessing(false);
    }
  };

  const copyToClipboard = (text: string) => {
    const el = document.createElement('textarea');
    el.value = text;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
  };

  const handleCopyTitle = (title: string) => {
    copyToClipboard(title);
    setCopiedTitle(title);
    setTimeout(() => setCopiedTitle(null), 2000);
  };
  
  const handleCopyAll = () => {
    if (!results) return;
    
    // Include Summary in the copy
    let summaryText = "";
    if (sourceSummary) {
        summaryText = `ã€ä¾†æºå°è¦½ã€‘\næ‘˜è¦ï¼š${sourceSummary.overview}\né—œéµå­—ï¼š${sourceSummary.tags.join(', ')}\n\n========================================\n\n`;
    }

    const allText = [
      summaryText,
      generateCopyString(results.A),
      '----------------------------------------',
      generateCopyString(results.B),
      '----------------------------------------',
      generateCopyString(results.Mix)
    ].join('\n\n');
    copyToClipboard(allText);
  };

  const currentResult = results ? results[activeVersion] : null;

  return (
    <div className="min-h-screen bg-gray-900 text-gray-100 font-sans selection:bg-indigo-500 selection:text-white pb-20">
      {/* Header */}
      <header className="border-b border-gray-800 bg-gray-900/50 backdrop-blur-md sticky top-0 z-10">
        <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="bg-gradient-to-tr from-indigo-500 to-purple-500 p-2 rounded-lg">
              <Users size={20} className="text-white" />
            </div>
            <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">
              æ¥µé€Ÿè…³æœ¬å¤§å¸« <span className="text-xs font-normal text-gray-500 px-2 border border-gray-700 rounded-full">Pro</span>
            </h1>
          </div>
          
          <div className="flex items-center gap-3">
             <div className="hidden md:flex items-center gap-1.5 px-3 py-1 rounded-full bg-gray-800 border border-gray-700 text-xs">
                {apiKey ? (
                   <>
                     <div className="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"></div>
                     <span className="text-gray-300">Gemini AI å°±ç·’</span>
                   </>
                ) : (
                   <>
                     <div className="w-2 h-2 rounded-full bg-yellow-500"></div>
                     <span className="text-gray-400">æ¼”ç¤ºæ¨¡å¼</span>
                   </>
                )}
             </div>

            <button 
              onClick={() => setShowSettings(!showSettings)}
              className={`p-2 rounded-full transition-colors ${showSettings ? 'bg-indigo-600 text-white' : 'hover:bg-gray-800 text-gray-400'}`}
              title="API è¨­å®š"
            >
              <Settings size={20} />
            </button>
          </div>
        </div>
        
        {/* Settings Panel */}
        {showSettings && (
          <div className="bg-gray-800 border-b border-gray-700 p-4 animate-in slide-in-from-top-2">
            <div className="max-w-6xl mx-auto flex flex-col md:flex-row gap-6">
              <div className="flex-1 w-full space-y-3">
                <div className="flex items-center gap-2 text-indigo-400 mb-1">
                  <Key size={16} />
                  <label className="text-sm font-bold">Google Gemini API Key</label>
                </div>
                <div className="relative">
                  <input 
                    type="password" 
                    value={apiKey}
                    onChange={(e) => setApiKey(e.target.value)}
                    placeholder="è¼¸å…¥æ‚¨çš„ AIzaSy..."
                    className="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all placeholder:text-gray-600"
                  />
                  {ENV_API_KEY && apiKey === ENV_API_KEY && (
                    <span className="absolute right-3 top-3 text-xs text-green-500 flex items-center gap-1 bg-green-900/20 px-2 rounded">
                      <Shield size={10} />
                      å·²è¼‰å…¥ç’°å¢ƒè®Šæ•¸
                    </span>
                  )}
                </div>
                <p className="text-xs text-gray-500">
                  è‹¥æœªè¼¸å…¥ Keyï¼Œç³»çµ±å°‡ä½¿ç”¨ <strong>æ¼”ç¤ºæ¨¡å¼ (Mock Data)</strong> ä¾†å±•ç¤ºä»‹é¢æ•ˆæœã€‚
                </p>
              </div>
            </div>
          </div>
        )}
      </header>

      <main className="max-w-6xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        {/* Left Column: Input */}
        <div className="space-y-6">
          <div className="flex items-center justify-between">
            <h2 className="text-lg font-semibold flex items-center gap-2">
              <FileText className="text-indigo-400" size={20} />
              åŸå§‹ç´ æ
            </h2>
            {fileContent && (
              <button 
                onClick={() => {setFileContent(''); setFileName(''); setResults(null); setSourceSummary(null);}}
                className="text-xs text-red-400 hover:text-red-300"
              >
                æ¸…é™¤å…§å®¹
              </button>
            )}
          </div>

          <div 
            className={`
              relative group border-2 border-dashed rounded-xl transition-all duration-300 h-[500px] flex flex-col
              ${isDragging ? 'border-indigo-500 bg-indigo-500/10' : 'border-gray-700 bg-gray-800/50 hover:border-gray-600'}
            `}
            onDragOver={handleDragOver}
            onDragLeave={handleDragLeave}
            onDrop={handleDrop}
          >
            {!fileContent ? (
              <div className="flex-1 flex flex-col items-center justify-center p-8 text-center">
                <div className="w-16 h-16 bg-gray-700 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                  <Upload className="text-gray-400" size={32} />
                </div>
                <h3 className="text-lg font-medium text-gray-200 mb-2">æ‹–æ”¾ .txt æª”æ¡ˆè‡³æ­¤</h3>
                <p className="text-sm text-gray-500 mb-6">æˆ–ç›´æ¥è²¼ä¸Šæ–‡å­—å…§å®¹</p>
                <label className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg cursor-pointer transition-colors shadow-lg shadow-indigo-600/20">
                  é¸æ“‡æª”æ¡ˆ
                  <input type="file" className="hidden" accept=".txt" onChange={handleFileSelect} />
                </label>
              </div>
            ) : (
              <div className="flex-1 flex flex-col p-4">
                <div className="flex items-center justify-between mb-2 text-xs text-gray-400">
                  <span className="truncate max-w-[200px]">{fileName || 'æ‰‹å‹•è¼¸å…¥'}</span>
                  <span>{fileContent.length} å­—</span>
                </div>
                <textarea 
                  className="flex-1 w-full bg-transparent resize-none focus:outline-none text-gray-300 text-sm leading-relaxed"
                  value={fileContent}
                  onChange={(e) => setFileContent(e.target.value)}
                  placeholder="åœ¨æ­¤ç·¨è¼¯æˆ–è²¼ä¸Šæ–‡å­—..."
                />
              </div>
            )}
            
            <div className="p-4 border-t border-gray-700 bg-gray-800 rounded-b-xl">
              <button
                onClick={handleAnalyze}
                disabled={isProcessing || !fileContent}
                className={`
                  w-full py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-all
                  ${isProcessing || !fileContent 
                    ? 'bg-gray-700 text-gray-500 cursor-not-allowed' 
                    : 'bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white shadow-lg shadow-indigo-900/50'}
                `}
              >
                {isProcessing ? (
                  <>
                    <RefreshCw className="animate-spin" size={20} />
                    æ­£åœ¨åˆ†æèˆ‡ç”Ÿæˆ...
                  </>
                ) : (
                  <>
                    <Zap size={20} />
                    {apiKey ? "é–‹å§‹ç”Ÿæˆ (Gemini AI)" : "é–‹å§‹ç”Ÿæˆ (æ¼”ç¤ºæ¨¡å¼)"}
                  </>
                )}
              </button>
            </div>
          </div>

          {error && (
            <div className="flex items-center gap-2 text-red-400 bg-red-900/20 p-3 rounded-lg text-sm border border-red-900/50 animate-in fade-in">
              <AlertCircle size={16} />
              {error}
            </div>
          )}
        </div>

        {/* Right Column: Output */}
        <div className="space-y-6">
           <h2 className="text-lg font-semibold flex items-center gap-2">
            <LayoutTemplate className="text-purple-400" size={20} />
            åˆ†æçµæœ
          </h2>

          {!currentResult ? (
            <div className="h-[500px] border border-gray-800 rounded-xl bg-gray-800/30 flex flex-col items-center justify-center text-gray-600">
              <div className="p-4 rounded-full bg-gray-800 mb-4">
                <Clock size={32} opacity={0.5} />
              </div>
              <p>ç­‰å¾…åˆ†æ...</p>
              <p className="text-sm mt-2 opacity-50">è«‹ä¸Šå‚³æ–‡å­—ä¸¦é»æ“Šç”Ÿæˆ</p>
            </div>
          ) : (
            <div className="flex flex-col h-full space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
              
              {/* NotebookLM Style Source Guide Card */}
              {sourceSummary && (
                <div className="bg-[#1e1e1e] rounded-xl border border-gray-700/50 p-5 shadow-2xl relative overflow-hidden group">
                  {/* Decorative Gradient */}
                  <div className="absolute top-0 right-0 w-64 h-64 bg-indigo-500/10 rounded-full blur-3xl -mr-32 -mt-32 pointer-events-none"></div>
                  
                  <div className="flex items-center gap-2 mb-3 text-indigo-400">
                    <Sparkles size={18} />
                    <h3 className="font-bold text-sm tracking-wide uppercase">ä¾†æºå°è¦½ (Source Guide)</h3>
                  </div>
                  
                  <div className="relative z-10">
                    <p className="text-gray-300 text-sm leading-relaxed mb-4">
                      {sourceSummary.overview}
                    </p>
                    <div className="flex flex-wrap gap-2">
                      {sourceSummary.tags.map((tag, i) => (
                        <span key={i} className="px-3 py-1 bg-gray-800 hover:bg-gray-700 text-gray-400 text-xs rounded-full border border-gray-700 transition-colors cursor-default">
                          #{tag}
                        </span>
                      ))}
                    </div>
                  </div>
                </div>
              )}

              {/* Scripts Section */}
              <div className="space-y-4">
                  {/* Version Tabs */}
                  <div className="flex p-1 bg-gray-800 rounded-lg">
                    <button 
                      onClick={() => setActiveVersion('A')}
                      className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${activeVersion === 'A' ? 'bg-indigo-600 text-white shadow' : 'text-gray-400 hover:text-white'}`}
                    >
                      ç‰ˆæœ¬ä¸€ (A)
                    </button>
                    <button 
                      onClick={() => setActiveVersion('B')}
                      className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${activeVersion === 'B' ? 'bg-pink-600 text-white shadow' : 'text-gray-400 hover:text-white'}`}
                    >
                      ç‰ˆæœ¬äºŒ (B)
                    </button>
                    <button 
                      onClick={() => setActiveVersion('Mix')}
                      className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${activeVersion === 'Mix' ? 'bg-purple-600 text-white shadow' : 'text-gray-400 hover:text-white'}`}
                    >
                      ç‰ˆæœ¬ä¸‰ (Mix)
                    </button>
                  </div>

                  {isMock && (
                    <div className="bg-yellow-900/30 border border-yellow-700/50 text-yellow-200 text-xs p-3 rounded-lg flex items-center gap-2">
                      <Info size={16} className="text-yellow-400" />
                      <span>æ¼”ç¤ºæ¨¡å¼ï¼šæ­¤ç‚ºæ¨¡æ“¬è³‡æ–™ã€‚è«‹è¼¸å…¥ API Key ä»¥ç²å¾—çœŸå¯¦åˆ†æã€‚</span>
                    </div>
                  )}

                  {/* The "Paper" */}
                  <div className="bg-white rounded-lg shadow-xl overflow-hidden flex flex-col text-gray-900 font-sans border border-gray-300">
                    {/* Blue Header Bar */}
                    <div className="bg-[#004e98] text-white p-3 flex justify-between items-center">
                      <div className="font-bold text-lg tracking-wide truncate pr-4">
                        {currentResult.versionName}: ã€{currentResult.title}ã€‘
                      </div>
                      <div className="text-xs bg-white/20 px-2 py-1 rounded whitespace-nowrap">
                        ç¸½æ™‚é•·: {currentResult.totalDuration}s
                      </div>
                    </div>

                    {/* Key Point Summary */}
                    <div className="bg-white p-4 text-center">
                      <p className="text-gray-800 font-medium">
                        <span className="font-bold text-[#004e98] mr-2">é‡é»:</span>
                        {currentResult.theme}
                      </p>
                    </div>

                    {/* IG Titles Section */}
                    {currentResult.suggestedTitles && currentResult.suggestedTitles.length > 0 && (
                        <div className="bg-gradient-to-r from-pink-50 to-purple-50 p-4 border-t border-b border-gray-200">
                          <h4 className="text-xs font-bold text-gray-500 uppercase mb-3 flex items-center gap-1.5">
                            <Instagram size={14} className="text-pink-600" />
                            IG Reels å¸ç›æ¨™é¡Œå»ºè­° (é»æ“Šè¤‡è£½)
                          </h4>
                          <div className="flex flex-wrap gap-2">
                            {currentResult.suggestedTitles.map((t, i) => (
                              <button 
                                key={i} 
                                onClick={() => handleCopyTitle(t)}
                                className={`
                                  px-3 py-1.5 rounded-full text-sm font-medium border shadow-sm transition-all
                                  ${copiedTitle === t 
                                    ? 'bg-green-100 border-green-300 text-green-700 scale-105' 
                                    : 'bg-white border-gray-200 text-gray-700 hover:border-pink-300 hover:text-pink-600 hover:bg-pink-50'
                                  }
                                `}
                              >
                                {copiedTitle === t ? 'å·²è¤‡è£½! âœ…' : t}
                              </button>
                            ))}
                          </div>
                        </div>
                    )}

                    {/* Table Header */}
                    <div className="grid grid-cols-12 border-b border-gray-300 bg-gray-50 text-sm font-bold text-gray-600">
                      <div className="col-span-3 p-3 border-r border-gray-200 text-center flex items-center justify-center">çµæ§‹</div>
                      <div className="col-span-2 p-3 border-r border-gray-200 text-center flex items-center justify-center">æ™‚é–“ä½”æ¯”</div>
                      <div className="col-span-7 p-3 text-center flex items-center justify-center">è…³æœ¬/å°ç™½é‡é» (Audio)</div>
                    </div>

                    {/* Table Body */}
                    <div className="overflow-auto max-h-[500px]">
                      {currentResult.sections.map((section, idx) => (
                        <div key={idx} className="grid grid-cols-12 border-b border-gray-200 text-sm hover:bg-gray-50 transition-colors">
                          <div className="col-span-3 p-3 border-r border-gray-200 font-bold text-gray-700 flex flex-col justify-center items-center text-center bg-gray-50/50">
                            <span className="text-lg text-[#004e98]">{section.structure}</span>
                            {section.structureDesc && (
                              <span className="text-xs text-gray-500 mt-1 font-normal break-words px-1">({section.structureDesc})</span>
                            )}
                          </div>
                          
                          <div className="col-span-2 p-3 border-r border-gray-200 flex items-center justify-center text-gray-600 font-mono text-center">
                            {formatTimeRange(currentResult.sections, idx)}
                          </div>

                          <div className="col-span-7 p-3 text-gray-800 leading-relaxed font-medium whitespace-pre-wrap">
                            {section.content}
                          </div>
                        </div>
                      ))}
                    </div>

                    {/* Footer / Actions */}
                    <div className="p-3 bg-gray-100 border-t border-gray-300 flex justify-end gap-2">
                      <button 
                        onClick={handleCopyAll}
                        className="flex items-center gap-2 px-4 py-2 bg-purple-700 hover:bg-purple-600 text-white rounded shadow-sm text-sm transition-colors"
                      >
                        <Files size={16} />
                        è¤‡è£½æ‰€æœ‰ (å«ä¾†æº)
                      </button>
                      <button 
                        onClick={() => {
                            const copyString = generateCopyString(currentResult);
                            copyToClipboard(copyString);
                        }}
                        className="flex items-center gap-2 px-4 py-2 bg-[#004e98] hover:bg-[#003d7a] text-white rounded shadow-sm text-sm transition-colors"
                      >
                        <Table size={16} />
                        è¤‡è£½æ­¤è…³æœ¬
                      </button>
                    </div>
                  </div>
              </div>
            </div>
          )}
        </div>

      </main>
    </div>
  );
}
